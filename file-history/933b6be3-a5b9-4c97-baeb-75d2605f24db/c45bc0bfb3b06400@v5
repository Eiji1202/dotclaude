import { randomUUID } from "node:crypto";
import { Router } from "express";
import {
  AUTH_LINE_REDIRECT_URL,
  AUTH_LINE_WEB_CALLBACK_URL,
} from "~/constants/url";
import { config } from "~/utils/config";
import { firebaseAdmin } from "~/utils/firebase";
import { prisma } from "~/utils/prisma";
import { saveToCloudStorage } from "~/infra/storage/cloudStorage";

const router = Router();
const DEFAULT_ICON =
  "https://storage.googleapis.com/utage3/assets/default-icon.png";

// ref: https://developers.line.biz/ja/reference/line-login/#get-profile-response
interface LINEProfileResponse {
  userId: string;
  displayName: string;
  pictureUrl?: string;
  statusMessage: string;
}

async function getProfile(token: string) {
  const res = await fetch("https://api.line.me/v2/profile", {
    method: "GET",
    headers: {
      Authorization: `Bearer ${token}`,
    },
  });

  if (!res.ok) {
    return null;
  }

  return (await res.json()) as LINEProfileResponse;
}

router.get("/", async (req, res) => {
  const url = new URL(req.originalUrl, "http://localhost");
  const searchParams = url.searchParams;
  const state = searchParams.get("state");
  const code = searchParams.get("code");
  const error = searchParams.get("error");

  if (error != null || code == null) {
    return res.status(400).json({ error });
  }

  const rb = new URLSearchParams();
  rb.append("grant_type", "authorization_code");
  rb.append("code", code);
  rb.append("redirect_uri", AUTH_LINE_REDIRECT_URL);
  rb.append("client_id", process.env.AUTH_LINE_CLIENT_ID);
  rb.append("client_secret", process.env.AUTH_LINE_CLIENT_SECRET);

  const tokenResponse = await fetch("https://api.line.me/oauth2/v2.1/token", {
    method: "POST",
    headers: {
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: rb,
  });

  if (!tokenResponse.ok) {
    return res
      .status(tokenResponse.status)
      .json({ error: tokenResponse.statusText });
  }

  interface TokenResponse {
    access_token: string;
    token_type: "Bearer";
    refresh_token: string;
    expired_in: number;
    scope: string;
    id_token: string;
  }

  const data = (await tokenResponse.json()) as TokenResponse;
  const profile = await getProfile(data.access_token);

  if (profile == null) {
    return res.status(400).json({ error: "Failed to get profile" });
  }

  const auth = firebaseAdmin.auth();

  const { token, isCreated } = await prisma.$transaction(async (tx) => {
    const user = await tx.user.findUnique({
      where: { lineId: profile.userId },
      select: { id: true },
    });

    if (user != null) {
      const token = await auth.createCustomToken(user.id);

      return { token, isCreated: false };
    }

    const imageURL = await (async () => {
      if (profile.pictureUrl == null) {
        return DEFAULT_ICON;
      }

      const res = await fetch(profile.pictureUrl);
      if (res.status !== 200) {
        return DEFAULT_ICON;
      }

      const buffer = Buffer.from(await res.arrayBuffer());
      const fileName = `uploaded/${randomUUID()}.png`;
      await saveToCloudStorage(buffer, fileName);

      return `https://storage.googleapis.com/${config.STORAGE_BUCKET}/${fileName}`;
    })();

    const newUser = await auth.createUser({
      displayName: profile.displayName,
      photoURL: imageURL,
    });
    const token = await auth.createCustomToken(newUser.uid);

    await tx.user.upsert({
      where: { lineId: profile.userId },
      create: {
        id: newUser.uid,
        name: profile.displayName,
        imageURL,
        lineId: profile.userId,
        // TODO: Phase 2でFirebase Tenant IDから動的に取得する
        tenantId: 1,
      },
      update: {
        name: profile.displayName,
        imageURL,
      },
    });

    return { token, isCreated: true };
  });

  res.cookie("custom-token", token, {
    domain: process.env.COOKIE_UTAGE_DOMAIN,
    path: "/",
    secure: true,
    // createCustomToken で作られたトークンは 1 時間有効だがすぐに無効にしたいので 10 分に設定
    maxAge: 1000 * 60 * 10,
  });

  const callbackUrl = new URL(AUTH_LINE_WEB_CALLBACK_URL);
  callbackUrl.searchParams.append("isNewUser", String(isCreated));
  callbackUrl.searchParams.append("state", String(state));

  return res.redirect(302, callbackUrl.toString());
});

export { router };
