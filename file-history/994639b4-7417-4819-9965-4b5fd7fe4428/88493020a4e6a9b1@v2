# テナントID伝搬方式の結論

## Context

マルチテナント化実装中に、同僚から以下の指摘があった：

> ファンは複数テナントに属する可能性があるのでユーザーとテナントはN:Nの関係になる。
> JWTに1つだけ埋め込む方式だと詰む。
> リクエストごとにtenantIdを渡す方式（ヘッダー）＋RLSでの検証が良いのでは？

## 結論: **JWTクレーム方式で問題なし（現在の設計書通り）**

### 理由

**Firebase Identity Platformのマルチテナンシーでは、テナントごとにユーザープールが分離される**。

つまり：
- 同じファン（同じメールアドレス）が複数テナントに登録する場合、**テナントごとに異なるUID**が生成される
- テナントAにログイン → JWT内に `firebase.tenant: "tenant-a"` が含まれる
- テナントBにログイン → JWT内に `firebase.tenant: "tenant-b"` が含まれる（別のUID）
- **1つのJWTに複数テナントIDを埋め込む必要はない**

### 同僚の懸念への回答

| 懸念 | 回答 |
|------|------|
| 「ユーザーとテナントはN:N」 | Firebase Identity Platformでは**テナントごとに別ユーザー（別UID）**なので、User:Tenant = **N:1で正しい** |
| 「JWTに1つだけ埋め込むと詰む」 | テナントごとに別のJWTが発行されるので**詰まない**。テナントAのアプリとテナントBのアプリは別々にログインする |
| 「リクエストヘッダーでtenant指定」 | JWTの`firebase.tenant`クレームから取得できるので**ヘッダー不要** |

### ユーザー体験

```
ファンAが「SUNTORY_龍が如く」のアプリ（suntory-yakuza.utage3.com）にアクセス
  → Firebase Tenant ID: "tenant-suntory-yakuza" でログイン
  → UID: abc123（このテナント内のUID）
  → プロフィール、カード、決済情報はこのテナント内で管理

ファンAが「LINE_吉本」のアプリ（line-yoshimoto.utage3.com）にアクセス
  → Firebase Tenant ID: "tenant-line-yoshimoto" でログイン（別途登録が必要）
  → UID: def456（別のUID）
  → プロフィール、カード、決済情報はこのテナント内で独立
```

---

## 現在のスキーマへの影響

### 変更不要

現在のスキーマ（User.tenantId = N:1）は**そのまま正しい**。

```prisma
model User {
  id       String @id // Firebase UID（テナントごとに異なる）
  tenantId String @map("tenant_id")  // 1つのテナントに属する
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  // ...
}
```

### tenantId伝搬方式

```
1. ユーザーがテナントAのアプリにアクセス
2. Firebase Auth でテナントAのユーザープールにログイン
3. JWT取得（firebase.tenant = "tenant-a" クレーム付き）
4. APIリクエスト → Authorizationヘッダーにセッションcookie
5. バックエンドミドルウェアでJWT検証 → firebase.tenantからtenantId取得
6. TenantテーブルでfirebaseTenantId → 内部tenantIdに変換
7. SET LOCAL app.current_tenant_id = ... → RLS適用
```

---

## 修正ファイル（Phase 2で実装）

### Go Backend
- `packages/api/internal/adapter/driver/middleware/firebase.go`
  - `decodedToken.Firebase.Tenant` からFirebase Tenant IDを取得
  - TenantRepositoryで内部tenant_idに変換
  - contextに設定

### Node.js Backend
- `packages/backend/src/context.ts`
  - `decoded.firebase?.tenant` からFirebase Tenant IDを取得
  - TenantRepositoryで変換

### フロントエンド（テナント提供方式確定後）
- Firebase Auth初期化時に `auth.tenantId` を設定
  ```typescript
  const auth = getAuth();
  auth.tenantId = "tenant-suntory-yakuza"; // テナント固有
  ```

---

## 検証方法

1. Firebase Consoleでテナントを2つ作成
2. テナントAでユーザー登録 → UID確認
3. テナントBで同じメールアドレスで登録 → **異なるUID**が生成されることを確認
4. テナントAのJWTに`firebase.tenant`クレームが含まれることを確認
5. バックエンドで`firebase.tenant`からtenantIdを正しく取得できることを確認
