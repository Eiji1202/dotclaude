# ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåŒ–å®Ÿè£…è¨ˆç”»

## Contextï¼ˆèƒŒæ™¯ï¼‰

ç¾åœ¨ã®UTAGE3.0ã‚·ã‚¹ãƒ†ãƒ ã¯ã‚·ãƒ³ã‚°ãƒ«ãƒ†ãƒŠãƒ³ãƒˆã‚’å‰æã¨ã—ã¦ãŠã‚Šã€è¤‡æ•°ã®IPãƒ–ãƒ©ãƒ³ãƒ‰ãŒæ··ã–ã‚‹çŠ¶æ…‹ã§ã—ã‹ã‚µãƒ¼ãƒ“ã‚¹ã‚’å±•é–‹ã§ããšã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç²å¾—ã®éšœå®³ã«ãªã£ã¦ã„ã¾ã™ã€‚ã“ã®å®Ÿè£…è¨ˆç”»ã¯ã€PostgreSQL Row Level Security (RLS)ã‚’æ´»ç”¨ã—ãŸãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆåŒ–ã«ã‚ˆã‚Šã€å˜ä¸€ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆåŸºç›¤ã‚’è¤‡æ•°ã®ç‹¬ç«‹ã—ãŸãƒ–ãƒ©ãƒ³ãƒ‰ã¸æ¨ªå±•é–‹å¯èƒ½ã«ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦ã„ã¾ã™ã€‚

**è¨­è¨ˆæ–¹é‡**:

- PostgreSQL RLSã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ç­‰ã§ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ï¼ˆæä¾›æ–¹å¼ã¯åˆ¥é€”ç¢ºå®šï¼‰
- Firebase Identity Platform Multi-tenancyã§èªè¨¼ã‚’åˆ†é›¢
- å„ãƒ†ãƒŠãƒ³ãƒˆã§å®Œå…¨ã«ç‹¬ç«‹ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ™ãƒ¼ã‚¹ï¼ˆUser:Tenant = N:1ï¼‰
- æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿ã‚‚ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã§ç®¡ç†

**tenantIdä¼æ¬æ–¹å¼**: JWTã‚¯ãƒ¬ãƒ¼ãƒ  + `X-Tenant-ID`ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼

- Firebase Identity Platformã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ã‚·ãƒ¼ã§ã¯ã€**ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ¼ãƒ«ãŒåˆ†é›¢**ã•ã‚Œã‚‹
- åŒä¸€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚ã€ãƒ†ãƒŠãƒ³ãƒˆãŒç•°ãªã‚Œã°ç•°ãªã‚‹UIDãŒç™ºè¡Œã•ã‚Œã‚‹
- **èªè¨¼ã‚ã‚Šã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: JWTã®`firebase.tenant`ã‚¯ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ä¸€æ„ã«ãƒ†ãƒŠãƒ³ãƒˆIDã‚’ç‰¹å®šï¼ˆæœ€å„ªå…ˆï¼‰
- **èªè¨¼ãªã—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…¬é–‹APIï¼‰**: `X-Tenant-ID`ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ†ãƒŠãƒ³ãƒˆIDã‚’ç‰¹å®š
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«`X-Tenant-ID`ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ã™ã‚‹

**ç¾åœ¨ã®çŠ¶æ…‹**:

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: 19ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨ã€ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãªã—
- Go Backend (`packages/api`): ä¸»è¦ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã€Cloud Run `rasen`ã‚µãƒ¼ãƒ“ã‚¹ (`rasen.utage3.com`)
- Node.js Backend (`packages/backend`): ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã€GraphQLã€Cloud Run `api`ã‚µãƒ¼ãƒ“ã‚¹ (`api.utage3.com`)
- **ä¸¡æ–¹ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒåŒã˜PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å…±æœ‰**
- **ä¸¡æ–¹ãŒæœ¬ç•ªç’°å¢ƒã§ç¨¼åƒä¸­** â†’ ä¸¡æ–¹ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ã‚ã‚Š
- Frontend: ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œå‡ºæœªå®Ÿè£…
- ãƒ‡ãƒ—ãƒ­ã‚¤: GitHub Actionsæ‰‹å‹•å®Ÿè¡Œã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã¯ç¾åœ¨ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆä¸­

---

## å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆ4ã¤ã®Phaseï¼‰

è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆ`docs/design-doc/multitenancy.md`ï¼‰ã«åŸºã¥ãã€æ®µéšçš„ã«å®Ÿè£…ã—ã¾ã™ã€‚

### **Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´**ï¼ˆå·¥æ•°: 2æ—¥ï¼‰

**ç›®çš„**: ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã®åŸºç›¤ã¨ãªã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’æº–å‚™

**å®Ÿè£…å†…å®¹**:

1. **Tenantãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ**
   - ãƒ•ã‚¡ã‚¤ãƒ«: `packages/backend/prisma/schema.prisma`
   - è¿½åŠ ã™ã‚‹ãƒ¢ãƒ‡ãƒ«ï¼ˆæœ€å°é™æ§‹æˆï¼‰:

     ```prisma
     model Tenant {
       id               String   @id @default(cuid())
       firebaseTenantId String   @unique @map("firebase_tenant_id")
       name             String   // ãƒ†ãƒŠãƒ³ãƒˆåï¼ˆä¾‹: "SUNTORY_é¾ãŒå¦‚ã", "LINE_å‰æœ¬", "tapirs_æµæ¯”ä¸­"ï¼‰
       createdAt        DateTime @default(now()) @map("created_at")
       updatedAt        DateTime @updatedAt @map("updated_at")

       // Relationsï¼ˆå…¨19ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
       users                                 User[]
       events                                Event[]
       eventSetlists                         EventSetlist[]
       packs                                 Pack[]
       packPrices                            PackPrice[]
       physicalPacks                         PhysicalPack[]
       certificates                          Certificate[]
       checkinCodes                          CheckinCode[]
       checkinTransactions                   CheckinTransaction[]
       tradingCards                          TradingCard[]
       tradingCardBenefits                   TradingCardBenefit[]
       tradingCardBenefitExchangeTransactions TradingCardBenefitExchangeTransaction[]
       packTradingCardRelations              PackTradingCardRelation[]
       userCertificates                      UserCertificate[]
       userTradingCards                      UserTradingCard[]
       quizSurveys                           QuizSurvey[]
       paymentMethods                        PaymentMethod[]
       paymentTransactions                   PaymentTransaction[]
       pairings                              Pairing[]

       @@map("tenant")
     }
     ```

   **è¨­è¨ˆæ–¹é‡**:
   - **YAGNIåŸå‰‡**: å¿…è¦æœ€å°é™ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å®Ÿè£…
   - **subdomainä¸è¦**: ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ã¯Firebase Tenant IDã§è¡Œã†ï¼ˆæä¾›æ–¹é‡ãŒæœªç¢ºå®šã®ãŸã‚ï¼‰
   - **ã‚«ãƒ†ã‚´ãƒªä¸è¦**: ãƒ†ãƒŠãƒ³ãƒˆåˆ†é¡ï¼ˆSUNTORY, LINEç­‰ï¼‰ã¯å°†æ¥å¿…è¦ã«ãªã£ãŸã‚‰è¿½åŠ 
   - **æ‹¡å¼µæ€§**: å°†æ¥çš„ã«subdomainã‚„categoryãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¿½åŠ ã¯å®¹æ˜“

2. **19ãƒ†ãƒ¼ãƒ–ãƒ«ã«tenant_idè¿½åŠ **
   - å¯¾è±¡: user, event, event_setlist, pack, pack_price, physical_pack, certificate, checkin_code, checkin_transaction, trading_card, trading_card_benefit, trading_card_benefit_exchange_transaction, pack_trading_card_relation, user_certificate, user_trading_card, quiz_survey, payment_method, payment_transaction, pairing
   - å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«`tenantId String @map("tenant_id")`ã¨`tenant Tenant @relation(...)`ã‚’è¿½åŠ 
   - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: `@@index([tenantId])`ã‚’è¿½åŠ 

3. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆ¦ç•¥**ï¼ˆé‡è¦ï¼‰:

   **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã§ã®æ‰‹é †**:

   ```bash
   cd packages/backend

   # Step 1: Tenantãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆschema.prismaã«Tenantãƒ¢ãƒ‡ãƒ«è¿½åŠ å¾Œï¼‰
   pnpm prisma migrate dev --create-only --name add_tenant_table

   # ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªãƒ»ç·¨é›†
   # packages/backend/prisma/migrations/YYYYMMDDHHMMSS_add_tenant_table/migration.sql

   # Step 2: 19ãƒ†ãƒ¼ãƒ–ãƒ«ã«tenant_idè¿½åŠ ï¼ˆschema.prismaã«è¿½åŠ å¾Œï¼‰
   pnpm prisma migrate dev --create-only --name add_tenant_id_to_all_tables

   # ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ç·¨é›†:
   ```

   **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹**ï¼ˆ`add_tenant_id_to_all_tables`ï¼‰:

   ```sql
   -- Step 1: tenant_idã‚’NULLè¨±å®¹ã§è¿½åŠ ï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ã¦ï¼‰
   ALTER TABLE "user" ADD COLUMN "tenant_id" TEXT;
   ALTER TABLE "event" ADD COLUMN "tenant_id" TEXT;
   ALTER TABLE "event_setlist" ADD COLUMN "tenant_id" TEXT;
   -- ... æ®‹ã‚Š16ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜

   -- Step 2: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒŠãƒ³ãƒˆãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
   -- æ³¨æ„: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ç‰¹å®šã®ãƒ†ãƒŠãƒ³ãƒˆã«ç´ä»˜ã‘ã‚‹æ–¹é‡ãŒæ±ºã¾ã£ãŸã‚‰ã€ã“ã®å€¤ã‚’å¤‰æ›´
   INSERT INTO "tenant" (id, firebase_tenant_id, name, created_at, updated_at)
   VALUES ('default-tenant', 'default-firebase-tenant', 'Default Tenant', NOW(), NOW())
   ON CONFLICT (id) DO NOTHING;

   -- Step 3: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«ï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ã¦ï¼‰
   UPDATE "user" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
   UPDATE "event" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
   UPDATE "event_setlist" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
   -- ... æ®‹ã‚Š16ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜

   -- Step 4: NOT NULLåˆ¶ç´„è¿½åŠ ï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ã¦ï¼‰
   ALTER TABLE "user" ALTER COLUMN "tenant_id" SET NOT NULL;
   ALTER TABLE "event" ALTER COLUMN "tenant_id" SET NOT NULL;
   ALTER TABLE "event_setlist" ALTER COLUMN "tenant_id" SET NOT NULL;
   -- ... æ®‹ã‚Š16ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜

   -- Step 5: å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„è¿½åŠ ï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ã¦ï¼‰
   ALTER TABLE "user" ADD CONSTRAINT "user_tenant_id_fkey"
       FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT;
   ALTER TABLE "event" ADD CONSTRAINT "event_tenant_id_fkey"
       FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT;
   -- ... æ®‹ã‚Š17ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜

   -- Step 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ã¦ï¼‰
   CREATE INDEX "user_tenant_id_idx" ON "user"("tenant_id");
   CREATE INDEX "event_tenant_id_idx" ON "event"("tenant_id");
   -- ... æ®‹ã‚Š17ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜
   ```

   **æœ¬ç•ªç’°å¢ƒã¸ã®é©ç”¨**:
   1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆãƒ»ç·¨é›†
   2. ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥
   3. `.github/workflows/deploy-backend-production.yaml`ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’æœ‰åŠ¹åŒ–ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤ï¼‰
   4. GitHub Actionsã‹ã‚‰æ‰‹å‹•å®Ÿè¡Œ:
      - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œæ™‚ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ãŒå…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹
      - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤

   **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—**:

   ```bash
   # æœ¬ç•ªç’°å¢ƒãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
   # Cloud SQLã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ã‚’ä½¿ç”¨
   ```

**ãƒªã‚¹ã‚¯**: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å¤±æ•—ã€æœ¬ç•ªç’°å¢ƒã§ã®åˆ¶ç´„è¿½åŠ ã‚¨ãƒ©ãƒ¼
**è»½æ¸›ç­–**:

- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§äº‹å‰ãƒ†ã‚¹ãƒˆ
- æœ¬ç•ªç’°å¢ƒã¯Cloud SQLã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ç¢ºèªå¾Œã«å®Ÿæ–½
- ä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚é–“å¸¯ï¼ˆæ·±å¤œï¼‰ã«å®Ÿæ–½
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œï¼ˆPrismaãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

---

### **Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¯¾å¿œ**ï¼ˆå·¥æ•°: 5ã€œ7æ—¥ï¼‰

**ç›®çš„**: RLSé©ç”¨ã®ä»•çµ„ã¿ã‚’å®Ÿè£…ï¼ˆãŸã ã—ãƒãƒªã‚·ãƒ¼ã¯æœªæœ‰åŠ¹åŒ– = Dry Runãƒ¢ãƒ¼ãƒ‰ï¼‰

#### **2.1 Go Backendå®Ÿè£…**ï¼ˆ3ã€œ4æ—¥ï¼‰

**å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—**:

**Step 1: Context Keyã®å®šç¾©**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/adapter/driver/middleware/context.go`

```go
package middleware

import "context"

type contextKey string

const (
    TenantIDContextKey contextKey = "tenantID"
)

// GetTenantIDFromContext ã¯contextã‹ã‚‰ãƒ†ãƒŠãƒ³ãƒˆIDã‚’å–å¾—
func GetTenantIDFromContext(ctx context.Context) (string, bool) {
    tenantID, ok := ctx.Value(TenantIDContextKey).(string)
    return tenantID, ok
}
```

**Step 2: ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/adapter/driver/middleware/firebase.go`ï¼ˆæ—¢å­˜ä¿®æ­£ï¼‰
**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/adapter/driver/middleware/tenant.go`

èªè¨¼ã‚ã‚Š/ãªã—ä¸¡æ–¹ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ãƒ†ãƒŠãƒ³ãƒˆIDã‚’è§£æ±ºã™ã‚‹ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’å®Ÿè£…:

```go
// tenant.go - ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
func ResolveTenant(tenantRepo store.TenantRepository) func(http.Handler) http.Handler {
    return func(next http.Handler) http.Handler {
        return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
            var firebaseTenantID string

            // 1. JWT ãŒã‚ã‚Œã° firebase.tenant ã‹ã‚‰å–å¾—ï¼ˆèªè¨¼æ¸ˆã¿ã€æœ€å„ªå…ˆï¼‰
            if token := GetFirebaseTokenFromContext(r.Context()); token != nil {
                if tenant, ok := token.Firebase.Tenant.(string); ok {
                    firebaseTenantID = tenant
                }
            }

            // 2. JWT ãŒãªã‘ã‚Œã° X-Tenant-ID ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—ï¼ˆå…¬é–‹APIï¼‰
            if firebaseTenantID == "" {
                firebaseTenantID = r.Header.Get("X-Tenant-ID")
            }

            // 3. ãƒ†ãƒŠãƒ³ãƒˆIDãŒå–å¾—ã§ããªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            if firebaseTenantID == "" {
                firebaseTenantID = "default"
            }

            // 4. Tenant ãƒ†ãƒ¼ãƒ–ãƒ«ã§å†…éƒ¨IDã«å¤‰æ›
            tenantID, err := tenantRepo.GetTenantIDByFirebaseTenantID(r.Context(), firebaseTenantID)
            if err != nil {
                http.Error(w, "tenant not found", http.StatusBadRequest)
                return
            }

            // 5. contextã«è¨­å®š â†’ RLS ã§ä½¿ç”¨
            ctx := context.WithValue(r.Context(), TenantIDContextKey, tenantID)
            next.ServeHTTP(w, r.WithContext(ctx))
        })
    }
}
```

**ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é©ç”¨é †åº**:
1. Firebaseèªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆJWTãŒã‚ã‚Œã°æ¤œè¨¼ã€contextã«ãƒˆãƒ¼ã‚¯ãƒ³è¨­å®šï¼‰
2. ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆJWT or ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ†ãƒŠãƒ³ãƒˆç‰¹å®šï¼‰

**Step 3: TenantRepositoryå®šç¾©**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/domain/repository/store/tenant.go`

```go
package store

import "context"

type TenantRepository interface {
    // GetTenantIDByFirebaseTenantID ã¯Firebase Tenant IDã‹ã‚‰å†…éƒ¨Tenant IDã‚’å–å¾—
    GetTenantIDByFirebaseTenantID(ctx context.Context, firebaseTenantID string) (string, error)
}
```

**Step 4: SQL Queryå®šç¾©**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/db/queries/tenant.sql`

```sql
-- name: GetTenantByFirebaseTenantID :one
SELECT id, firebase_tenant_id, name, created_at, updated_at
FROM "tenant"
WHERE firebase_tenant_id = $1
LIMIT 1;
```

**ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**:

```bash
cd packages/api
make gen  # sqlcãŒè‡ªå‹•ç”Ÿæˆ
```

**Step 5: TenantRepositoryå®Ÿè£…**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/adapter/gateway/rds/repository/tenant.go`

```go
package repository

import (
    "context"
    "utage3/packages/api/internal/db/rdb"
    "utage3/packages/api/internal/domain/repository/store"
)

type tenantRepository struct {
    queries *rdb.Queries
}

func NewTenantRepository(queries *rdb.Queries) store.TenantRepository {
    return &tenantRepository{queries: queries}
}

func (r *tenantRepository) GetTenantIDByFirebaseTenantID(ctx context.Context, firebaseTenantID string) (string, error) {
    tenant, err := r.queries.GetTenantByFirebaseTenantID(ctx, firebaseTenantID)
    if err != nil {
        return "", err
    }
    return tenant.ID, nil
}
```

**Step 6: RLSå¯¾å¿œï¼ˆSET LOCALå®Ÿè£…ï¼‰**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/adapter/gateway/rds/repository/store.go`ï¼ˆæœ€é‡è¦ï¼‰

æ—¢å­˜ã®`PgxExecutor`ã«ä»¥ä¸‹ã‚’è¿½åŠ :

```go
// setTenantContext ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ãƒ†ãƒŠãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
// Phase 2ã§ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦å®Ÿè£…ã®ã¿æº–å‚™
func (p *PgxExecutor) setTenantContext(ctx context.Context, tx pgx.Tx) error {
    tenantID, ok := middleware.GetTenantIDFromContext(ctx)
    if !ok {
        // ãƒ†ãƒŠãƒ³ãƒˆIDãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç®¡ç†è€…æ“ä½œãªã©ï¼‰
        return nil
    }

    // Phase 3ã§æœ‰åŠ¹åŒ–: RLSãƒãƒªã‚·ãƒ¼ç”¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã‚’è¨­å®š
    // _, err := tx.Exec(ctx, "SET LOCAL app.current_tenant_id = $1", tenantID)
    // if err != nil {
    //     return fmt.Errorf("failed to set tenant context: %w", err)
    // }

    return nil
}

// WithTx ã®ä¿®æ­£: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹å¾Œã«setTenantContextã‚’å‘¼ã³å‡ºã™
func (p *PgxExecutor) WithTx(ctx context.Context, fn func(context.Context) error) error {
    tx, err := p.pool.Begin(ctx)
    if err != nil {
        return err
    }
    defer tx.Rollback(ctx)

    // ãƒ†ãƒŠãƒ³ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
    if err := p.setTenantContext(ctx, tx); err != nil {
        return err
    }

    if err := fn(ctx); err != nil {
        return err
    }

    return tx.Commit(ctx)
}
```

**Step 7: Dependency Injectionï¼ˆWireï¼‰æ›´æ–°**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/di/wire.go`

TenantRepositoryã‚’ProviderSetã«è¿½åŠ :

```go
var RepositorySet = wire.NewSet(
    // æ—¢å­˜ã®ãƒªãƒã‚¸ãƒˆãƒª...
    repository.NewTenantRepository,
)
```

**ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ**:

```bash
cd packages/api
make gen  # wireãŒè‡ªå‹•ç”Ÿæˆ
```

**Phase 2å®Œäº†æ™‚ã®çŠ¶æ…‹**:

- âœ… Firebase Tenant IDã®æŠ½å‡ºæ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿
- âœ… TenantRepositoryã§Firebase Tenant ID â†’ å†…éƒ¨Tenant IDã®å¤‰æ›ãŒå¯èƒ½
- âœ… `SET LOCAL`ã®ä»•çµ„ã¿ã¯å®Ÿè£…æ¸ˆã¿ã ãŒã€**ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆçŠ¶æ…‹**
- âœ… æ—¢å­˜ã®å‹•ä½œã«å½±éŸ¿ãªã—ï¼ˆRLSãƒãƒªã‚·ãƒ¼æœªæœ‰åŠ¹åŒ–ï¼‰

**ãƒ†ã‚¹ãƒˆ**:

```bash
cd packages/api
make test

# æ–°è¦ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:
# packages/api/internal/adapter/gateway/rds/repository/tenant_test.go
```

**ãƒ‡ãƒ—ãƒ­ã‚¤**:

```bash
# GitHub Actions > deploy-rasen-production > Run workflow
```

#### **2.2 Node.js Backendå®Ÿè£…**ï¼ˆ2ã€œ3æ—¥ï¼‰

**å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—**:

**Step 1: Prisma Client Extensionä½œæˆï¼ˆRLSå¯¾å¿œï¼‰**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/utils/tenantPrisma.ts`

```typescript
import { PrismaClient } from "@prisma/client";
import type { Prisma } from "@prisma/client";

// ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—Prisma Clientã‚’ä½œæˆ
// Phase 2ã§ã¯SET LOCALã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã¦å®Ÿè£…ã®ã¿æº–å‚™
export function createTenantClient(tenantId: string) {
  const prisma = new PrismaClient();

  return prisma.$extends({
    query: {
      $allModels: {
        async $allOperations({ args, query, model }) {
          // å…¨æ“ä½œã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
          return prisma.$transaction(async (tx) => {
            // Phase 3ã§æœ‰åŠ¹åŒ–: RLSç”¨ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ã‚’è¨­å®š
            // await tx.$executeRawUnsafe(
            //   `SET LOCAL app.current_tenant_id = '${tenantId}'`
            // );

            // ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
            return query(args);
          });
        },
      },
    },
  });
}

// ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—Prisma Clientã®å‹å®šç¾©
export type TenantPrismaClient = ReturnType<typeof createTenantClient>;
```

**Step 2: Contextå‹å®šç¾©ã®æ›´æ–°**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/types/context.ts`

æ—¢å­˜ã®ContextInjectå‹ã«`tenantId`ã¨`tenantClient`ã‚’è¿½åŠ :

```typescript
import type { TenantPrismaClient } from "@/utils/tenantPrisma";

export type ContextInject = {
  repository: Repository;
  sideEffect: SideEffect;
  config: Config;
  uid: string; // æ—¢å­˜
  // æ–°è¦è¿½åŠ 
  tenantId: string;
  tenantClient: TenantPrismaClient;
};
```

**Step 3: Contextç”Ÿæˆæ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆæƒ…å ±ã‚’è¿½åŠ **

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/context.ts`

èªè¨¼ã‚ã‚Š/ãªã—ä¸¡æ–¹ã®ã‚±ãƒ¼ã‚¹ã§Firebase Tenant IDã‚’è§£æ±ºã—ã€Contextã«è¿½åŠ :

```typescript
import { createTenantClient } from "@/utils/tenantPrisma";

export async function createContext({ req }): Promise<ContextInject> {
  // æ—¢å­˜ã®Firebaseèªè¨¼å‡¦ç†...
  const decoded = await verifyIdToken(token);

  // Firebase Tenant IDã‚’è§£æ±ºï¼ˆå„ªå…ˆé †ä½: JWT > ãƒ˜ãƒƒãƒ€ãƒ¼ > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  let firebaseTenantId: string;

  if (decoded?.firebase?.tenant) {
    // 1. èªè¨¼ã‚ã‚Šã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: JWTã‹ã‚‰å–å¾—ï¼ˆæœ€å„ªå…ˆï¼‰
    firebaseTenantId = decoded.firebase.tenant as string;
  } else if (req.headers["x-tenant-id"]) {
    // 2. èªè¨¼ãªã—ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆå…¬é–‹APIï¼‰: ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰å–å¾—
    firebaseTenantId = req.headers["x-tenant-id"] as string;
  } else {
    // 3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    firebaseTenantId = "default";
  }

  // ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—Prisma Clientã‚’ä½œæˆ
  const tenantClient = createTenantClient(firebaseTenantId);

  // TODO: Phase 2å¾ŒåŠã§TenantRepositoryã‚’ä½¿ç”¨ã—ã¦Firebase Tenant ID â†’ å†…éƒ¨Tenant IDã®å¤‰æ›

  return {
    repository,
    sideEffect,
    config,
    uid: decoded?.uid,
    tenantId: firebaseTenantId,
    tenantClient,
  };
}
```

**Step 4: TenantRepositoryå®šç¾©ï¼ˆFirebase Tenant IDå¤‰æ›ç”¨ï¼‰**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/infra/repository/tenantRepository.ts`

```typescript
import type { PrismaClient, Tenant } from "@prisma/client";

export interface TenantRepository {
  // Firebase Tenant IDã‹ã‚‰å†…éƒ¨Tenant IDã‚’å–å¾—
  getTenantByFirebaseTenantId(firebaseTenantId: string): Promise<Tenant | null>;
}

export class TenantRepositoryImpl implements TenantRepository {
  constructor(private readonly prisma: PrismaClient) {}

  async getTenantByFirebaseTenantId(
    firebaseTenantId: string,
  ): Promise<Tenant | null> {
    return this.prisma.tenant.findUnique({
      where: {
        firebaseTenantId,
      },
    });
  }
}
```

**Step 5: Repositoryé›†ç´„ã«è¿½åŠ **

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/infra/repository/index.ts`

```typescript
import { TenantRepositoryImpl } from "./tenantRepository";

export const createRepository = (prisma: PrismaClient) => ({
  // æ—¢å­˜ã®ãƒªãƒã‚¸ãƒˆãƒª...
  tenant: new TenantRepositoryImpl(prisma),
});

export type Repository = ReturnType<typeof createRepository>;
```

**Step 6: Contextç”Ÿæˆæ™‚ã«Firebase Tenant ID â†’ å†…éƒ¨Tenant IDã®å¤‰æ›**

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/backend/src/context.ts`ï¼ˆä¿®æ­£ï¼‰

```typescript
export async function createContext({ req }): Promise<ContextInject> {
  // ... æ—¢å­˜ã®èªè¨¼å‡¦ç† ...

  const firebaseTenantId =
    (decoded.firebase?.tenant as string | undefined) ||
    "default-firebase-tenant";

  // Firebase Tenant ID â†’ å†…éƒ¨Tenant IDã®å¤‰æ›
  const tenant =
    await repository.tenant.getTenantByFirebaseTenantId(firebaseTenantId);
  const tenantId = tenant?.id || "default-tenant"; // å†…éƒ¨Tenant ID

  // ãƒ†ãƒŠãƒ³ãƒˆã‚¹ã‚³ãƒ¼ãƒ—Prisma Clientã‚’ä½œæˆ
  const tenantClient = createTenantClient(tenantId);

  return {
    repository,
    sideEffect,
    config,
    uid: decoded.uid,
    tenantId, // å†…éƒ¨Tenant ID
    tenantClient,
  };
}
```

**Phase 2å®Œäº†æ™‚ã®çŠ¶æ…‹**:

- âœ… Firebase Tenant IDã®æŠ½å‡ºæ©Ÿèƒ½ãŒå®Ÿè£…æ¸ˆã¿
- âœ… TenantRepositoryã§Firebase Tenant ID â†’ å†…éƒ¨Tenant IDã®å¤‰æ›ãŒå¯èƒ½
- âœ… Prisma Client Extensionã§SET LOCALã®ä»•çµ„ã¿ã¯å®Ÿè£…æ¸ˆã¿ã ãŒã€**ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆçŠ¶æ…‹**
- âœ… æ—¢å­˜ã®å‹•ä½œã«å½±éŸ¿ãªã—ï¼ˆRLSãƒãƒªã‚·ãƒ¼æœªæœ‰åŠ¹åŒ–ï¼‰

**ãƒ†ã‚¹ãƒˆ**:

```bash
cd packages/backend
pnpm test

# æ–°è¦ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«:
# packages/backend/src/utils/tenantPrisma.test.ts
# packages/backend/src/infra/repository/tenantRepository.test.ts
```

**ãƒ‡ãƒ—ãƒ­ã‚¤**:

```bash
# GitHub Actions > deploy-backend-production > Run workflow
```

---

### **Phase 3: RLSæœ‰åŠ¹åŒ–**ï¼ˆå·¥æ•°: 3ã€œ4æ—¥ï¼‰

**ç›®çš„**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ã‚’å¼·åˆ¶

**æ³¨æ„**: æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ãŒå¤§ãã„ãŸã‚ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ååˆ†ã«ãƒ†ã‚¹ãƒˆå¾Œã«å®Ÿæ–½

#### **3.1 RLSãƒãƒªã‚·ãƒ¼å®šç¾©ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ**ï¼ˆ1æ—¥ï¼‰

**ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ**:

```bash
cd packages/backend

# RLSãƒãƒªã‚·ãƒ¼ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
pnpm prisma migrate dev --create-only --name enable_rls_policies
```

**ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†**: `packages/backend/prisma/migrations/YYYYMMDDHHMMSS_enable_rls_policies/migration.sql`

```sql
-- ========================================
-- RLSæœ‰åŠ¹åŒ–ã¨ãƒãƒªã‚·ãƒ¼ä½œæˆ
-- ========================================

-- 19ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ã¦ã§RLSã‚’æœ‰åŠ¹åŒ–
ALTER TABLE "user" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "event" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "event_setlist" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "pack" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "pack_price" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "physical_pack" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "certificate" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "checkin_code" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "checkin_transaction" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "trading_card" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "trading_card_benefit" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "trading_card_benefit_exchange_transaction" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "pack_trading_card_relation" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "user_certificate" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "user_trading_card" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "quiz_survey" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "payment_method" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "payment_transaction" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "pairing" ENABLE ROW LEVEL SECURITY;

-- å„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ†ãƒŠãƒ³ãƒˆåˆ†é›¢ãƒãƒªã‚·ãƒ¼ã‚’ä½œæˆ
-- ãƒãƒªã‚·ãƒ¼å: tenant_isolation_policy
-- FOR ALL: SELECT/INSERT/UPDATE/DELETEå…¨æ“ä½œã«é©ç”¨
-- USING: èª­ã¿å–ã‚Šæ™‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶
-- WITH CHECK: æ›¸ãè¾¼ã¿æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶

CREATE POLICY tenant_isolation_policy ON "user"
    FOR ALL
    USING ("tenant_id" = current_setting('app.current_tenant_id', true))
    WITH CHECK ("tenant_id" = current_setting('app.current_tenant_id', true));

CREATE POLICY tenant_isolation_policy ON "event"
    FOR ALL
    USING ("tenant_id" = current_setting('app.current_tenant_id', true))
    WITH CHECK ("tenant_id" = current_setting('app.current_tenant_id', true));

CREATE POLICY tenant_isolation_policy ON "event_setlist"
    FOR ALL
    USING ("tenant_id" = current_setting('app.current_tenant_id', true))
    WITH CHECK ("tenant_id" = current_setting('app.current_tenant_id', true));

-- ... æ®‹ã‚Š16ãƒ†ãƒ¼ãƒ–ãƒ«ã‚‚åŒæ§˜ã®ãƒãƒªã‚·ãƒ¼ä½œæˆ

-- æ³¨æ„: current_setting('app.current_tenant_id', true)
-- ç¬¬2å¼•æ•°trueã¯NULLè¨±å®¹ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°ãŒæœªè¨­å®šã®å ´åˆã‚¨ãƒ©ãƒ¼ã«ãªã‚‰ãªã„ï¼‰
```

**ãƒãƒªã‚·ãƒ¼ã®æ„å‘³**:

- `FOR ALL`: SELECT/INSERT/UPDATE/DELETEå…¨æ“ä½œã«é©ç”¨
- `USING`: ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¡ä»¶ï¼ˆWHEREå¥ã«è‡ªå‹•è¿½åŠ ï¼‰
- `WITH CHECK`: INSERT/UPDATEæ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶
- `current_setting('app.current_tenant_id', true)`: ã‚»ãƒƒã‚·ãƒ§ãƒ³å¤‰æ•°`app.current_tenant_id`ã‹ã‚‰å–å¾—ï¼ˆç¬¬2å¼•æ•°trueã§NULLè¨±å®¹ï¼‰

**é‡è¦**: ã“ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€**SET LOCALã§ãƒ†ãƒŠãƒ³ãƒˆIDã‚’è¨­å®šã—ãªã„ã¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯**ã«ãªã‚Šã¾ã™ã€‚Phase 2ã§SET LOCALã®å®Ÿè£…ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

#### **3.2 SET LOCALæœ‰åŠ¹åŒ–**ï¼ˆ0.5æ—¥ï¼‰

**Phase 2ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ãŸã‚³ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–**:

**1. Go Backend**: `packages/api/internal/adapter/gateway/rds/repository/store.go`

```go
// setTenantContext ã®ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
func (p *PgxExecutor) setTenantContext(ctx context.Context, tx pgx.Tx) error {
    tenantID, ok := middleware.GetTenantIDFromContext(ctx)
    if !ok {
        return nil
    }

    // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤
    _, err := tx.Exec(ctx, "SET LOCAL app.current_tenant_id = $1", tenantID)
    if err != nil {
        return fmt.Errorf("failed to set tenant context: %w", err)
    }

    return nil
}
```

**2. Node.js Backend**: `packages/backend/src/utils/tenantPrisma.ts`

```typescript
export function createTenantClient(tenantId: string) {
  const prisma = new PrismaClient();

  return prisma.$extends({
    query: {
      $allModels: {
        async $allOperations({ args, query, model }) {
          return prisma.$transaction(async (tx) => {
            // ã‚³ãƒ¡ãƒ³ãƒˆã‚’è§£é™¤
            await tx.$executeRawUnsafe(
              `SET LOCAL app.current_tenant_id = '${tenantId}'`,
            );

            return query(args);
          });
        },
      },
    },
  });
}
```

**ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥**:

```bash
git add .
git commit -m "feat: enable RLS policies and SET LOCAL for multitenancy (Phase 3)"
git push origin main
```

#### **3.3 ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ**ï¼ˆ2ã€œ3æ—¥ï¼‰

**å‰æ**: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§Phase 1, 2ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨

**Step 1: ãƒ†ãƒŠãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ**

```sql
-- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒDBã«æ¥ç¶šã—ã¦ãƒ†ãƒŠãƒ³ãƒˆä½œæˆ
INSERT INTO "tenant" (id, firebase_tenant_id, name, created_at, updated_at)
VALUES
  ('tenant-a-id', 'firebase-tenant-a', 'Artist A', NOW(), NOW()),
  ('tenant-b-id', 'firebase-tenant-b', 'Artist B', NOW(), NOW());
```

**Step 2: Firebase Tenantã®è¨­å®š**

Firebase Consoleã§2ã¤ã®ãƒ†ãƒŠãƒ³ãƒˆã‚’ä½œæˆ:

- `firebase-tenant-a`
- `firebase-tenant-b`

**Step 3: ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ãƒ†ã‚¹ãƒˆ**

1. **ãƒ†ãƒŠãƒ³ãƒˆAã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³**:
   - Firebase Tenant ID `firebase-tenant-a`ã‚’è¨­å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼Aç™»éŒ²
   - Firebase Auth Tokenã«Tenant ID `firebase-tenant-a`ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - æ³¨æ„: ãƒ†ãƒŠãƒ³ãƒˆæä¾›æ–¹æ³•ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ç­‰ï¼‰ãŒç¢ºå®šã—ãŸã‚‰ã€ãã‚Œã«å¾“ã†

2. **ãƒ†ãƒŠãƒ³ãƒˆBã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³**:
   - Firebase Tenant ID `firebase-tenant-b`ã‚’è¨­å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼Bç™»éŒ²
   - Firebase Auth Tokenã«Tenant ID `firebase-tenant-b`ãŒå«ã¾ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

3. **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã®ç¢ºèª**:
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ è‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿è¡¨ç¤º
   - ãƒ†ãƒŠãƒ³ãƒˆAã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ†ãƒŠãƒ³ãƒˆBã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ãƒ‘ãƒƒã‚¯ã‚’è¦‹ã‚‰ã‚Œãªã„ã“ã¨ã‚’ç¢ºèª

**Step 4: ä¸»è¦ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ**

å„ãƒ†ãƒŠãƒ³ãƒˆã§ä»¥ä¸‹ã®ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ:

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
2. ã‚¤ãƒ™ãƒ³ãƒˆä½œæˆï¼ˆç®¡ç†ç”»é¢ï¼‰
3. ãƒ‘ãƒƒã‚¯è³¼å…¥
4. ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰ç™ºè¡Œ
5. ã‚«ãƒ¼ãƒ‰ç²å¾—
6. æ±ºæ¸ˆå‡¦ç†

**Step 5: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥ç¢ºèª**

```sql
-- ãƒ†ãƒŠãƒ³ãƒˆAã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°
SELECT COUNT(*) FROM "user" WHERE tenant_id = 'tenant-a-id';

-- ãƒ†ãƒŠãƒ³ãƒˆBã®ã‚¤ãƒ™ãƒ³ãƒˆä¸€è¦§
SELECT * FROM "event" WHERE tenant_id = 'tenant-b-id';

-- RLSå‹•ä½œç¢ºèª: ãƒ†ãƒŠãƒ³ãƒˆAã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
BEGIN;
SET LOCAL app.current_tenant_id = 'tenant-a-id';
SELECT * FROM "user";  -- ãƒ†ãƒŠãƒ³ãƒˆAã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
ROLLBACK;

-- RLSå‹•ä½œç¢ºèª: ãƒ†ãƒŠãƒ³ãƒˆBã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
BEGIN;
SET LOCAL app.current_tenant_id = 'tenant-b-id';
SELECT * FROM "user";  -- ãƒ†ãƒŠãƒ³ãƒˆBã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹ã¯ãš
ROLLBACK;
```

**Step 6: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ**

- **Go**: `packages/api/internal/adapter/gateway/rds/repository/store_test.go` - RLSåˆ†é›¢ã®ãƒ†ã‚¹ãƒˆ
- **Node.js**: `packages/backend/src/utils/tenantPrisma.test.ts` - Prismaæ‹¡å¼µã®ãƒ†ã‚¹ãƒˆ

```bash
# Goãƒ†ã‚¹ãƒˆ
cd packages/api && make test

# Node.jsãƒ†ã‚¹ãƒˆ
cd packages/backend && pnpm test
```

**Step 7: ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**

- **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–**: RLSãƒãƒªã‚·ãƒ¼é•åã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã„ãªã„ã‹ç¢ºèª
- **ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: Phase 2æ¯”ã§ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å¤‰åŒ–ã‚’ç›£è¦–
- **ç›®æ¨™**: ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·åŠ£åŒ–20%ä»¥å†…

#### **3.4 æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †**ï¼ˆé‡è¦ï¼‰

**âš ï¸ æ³¨æ„**: æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ãŒå¤§ãã„ãŸã‚ã€ä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚é–“å¸¯ï¼ˆæ·±å¤œï¼‰ã«å®Ÿæ–½

**ãƒ‡ãƒ—ãƒ­ã‚¤é †åº**:

1. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—**:
   - Cloud SQLã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒæœ‰åŠ¹ã‹ç¢ºèª
   - æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’è¿½åŠ ã§å–å¾—

2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ**:

   ```bash
   # .github/workflows/deploy-backend-production.yaml ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’æœ‰åŠ¹åŒ–
   # GitHub Actions > deploy-backend-production > Run workflow
   ```

   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ãŒ**å…ˆã«**å®Ÿè¡Œã•ã‚Œã‚‹
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤

3. **ä¸¡æ–¹ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤**:

   ```bash
   # GraphQL (api) ãƒ‡ãƒ—ãƒ­ã‚¤
   # GitHub Actions > deploy-backend-production > Run workflow

   # Go (rasen) ãƒ‡ãƒ—ãƒ­ã‚¤
   # GitHub Actions > deploy-rasen-production > Run workflow
   ```

   - **æ³¨æ„**: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã€é€Ÿã‚„ã‹ã«ä¸¡æ–¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤
   - RLSæœ‰åŠ¹åŒ–å¾Œã€SET LOCALãªã—ã§ã¯ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ã«ãªã‚‹ãŸã‚

4. **æœ¬ç•ªç’°å¢ƒå‹•ä½œç¢ºèª**:
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ç¢ºèª
   - æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãŒæ­£å¸¸ã‹ç¢ºèª
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«RLSãƒãƒªã‚·ãƒ¼é•åãŒãªã„ã‹ç¢ºèª

5. **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**:
   - Sentryã§ã‚¨ãƒ©ãƒ¼ç›£è¦–
   - Cloud Loggingã§ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
   - ç•°å¸¸ãŒã‚ã‚Œã°å³åº§ã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

#### **3.5 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †**ï¼ˆç·Šæ€¥æ™‚ï¼‰

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹RLSã®ç„¡åŠ¹åŒ–**:

```sql
-- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
ALTER TABLE "user" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "event" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "event_setlist" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "pack" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "pack_price" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "physical_pack" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "certificate" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "checkin_code" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "checkin_transaction" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "trading_card" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "trading_card_benefit" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "trading_card_benefit_exchange_transaction" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "pack_trading_card_relation" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "user_certificate" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "user_trading_card" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "quiz_survey" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "payment_method" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "payment_transaction" DISABLE ROW LEVEL SECURITY;
ALTER TABLE "pairing" DISABLE ROW LEVEL SECURITY;
```

**ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**:

- Phase 2ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æˆ»ã™ï¼ˆSET LOCALãŒã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼‰
- GitHub Actionsã‹ã‚‰å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

---

### **Phase 4: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**ï¼ˆå·¥æ•°: 3ã€œ4æ—¥ï¼‰

**ç›®çš„**: RLSç¨¼åƒç¢ºèªå¾Œã€å†—é•·ãªã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤

**å®Ÿè£…å†…å®¹**:

1. **å†—é•·ãªWHEREå¥ã®å‰Šé™¤**ï¼ˆ2ã€œ3æ—¥ï¼‰
   - å¯¾è±¡: `packages/backend/src/infra/repository/*.ts`ï¼ˆå…¨7ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
   - å¯¾è±¡: `packages/api/internal/db/queries/*.sql`ï¼ˆå…¨4ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
   - ä¾‹: `WHERE user.tenantId = $1`ã®ã‚ˆã†ãªæ˜ç¤ºçš„ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å‰Šé™¤ï¼ˆRLSãŒè‡ªå‹•é©ç”¨ï¼‰
   - **æ³¨æ„**: RLSãŒç¢ºå®Ÿã«æ©Ÿèƒ½ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰å‰Šé™¤

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**ï¼ˆ1æ—¥ï¼‰
   - `EXPLAIN ANALYZE`ã§ã‚¯ã‚¨ãƒªãƒ—ãƒ©ãƒ³ç¢ºèª
   - è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®è¿½åŠ ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰:
     ```sql
     CREATE INDEX user_tenant_id_email_idx ON "user"(tenant_id, email);
     CREATE INDEX event_tenant_id_start_date_idx ON "event"(tenant_id, start_date);
     ```

---

## ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œå‡ºã¨Firebase Tenantçµ±åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã€æä¾›æ–¹é‡æœªç¢ºå®šï¼‰

**æ³¨æ„**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯**ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«**ã§ã™ã€‚ãƒ†ãƒŠãƒ³ãƒˆæä¾›æ–¹é‡ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ or ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ or ãã®ä»–ï¼‰ãŒæœªç¢ºå®šã®ãŸã‚ã€å¿…è¦ã«å¿œã˜ã¦å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

**ä¸¦è¡Œå®Ÿè£…å¯èƒ½**ï¼ˆPhase 2ã¨åŒæ™‚é€²è¡Œå¯ã€ãŸã ã—æä¾›æ–¹é‡ç¢ºå®šå¾Œï¼‰

### **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/web/app/utils/tenant.ts`

```typescript
// ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‹ã‚‰Firebase Tenant IDã‚’è§£æ±º
export function getSubdomain(): string {
  const hostname = window.location.hostname;
  // artist-a.utage3.com â†’ "artist-a"
  return hostname.split(".")[0] || "default";
}

// APIçµŒç”±ã§Firebase Tenant IDå–å¾—ï¼ˆæ¨å¥¨ï¼‰
export async function fetchFirebaseTenantId(
  subdomain: string,
): Promise<string> {
  const response = await fetch(`/api/tenant/resolve?subdomain=${subdomain}`);
  return (await response.json()).firebaseTenantId;
}
```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/web/app/features/auth/Auth.tsx`ï¼ˆæ¨æ¸¬ï¼‰

- Firebase AuthåˆæœŸåŒ–æ™‚ã«ãƒ†ãƒŠãƒ³ãƒˆIDã‚’è¨­å®š:
  ```typescript
  const auth = getAuth();
  auth.tenantId = await fetchFirebaseTenantId(getSubdomain());
  ```

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/web/app/lib/api/transport.ts`

- å…¨APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã« `X-Tenant-ID` ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸ï¼ˆå…¬é–‹APIå¯¾å¿œï¼‰:
  ```typescript
  const transport = createConnectTransport({
    baseUrl: API_ORIGIN,
    interceptors: [
      (next) => async (req) => {
        // å…¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ†ãƒŠãƒ³ãƒˆIDãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä»˜ä¸
        // èªè¨¼ã‚ã‚Šã®å ´åˆã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§JWTãŒå„ªå…ˆã•ã‚Œã‚‹
        req.header.set("X-Tenant-ID", FIREBASE_TENANT_ID);
        return next(req);
      },
    ],
  });
  ```

### **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…**

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/api/internal/adapter/driver/proto/tenant.go`

- ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ â†’ Firebase Tenant IDè§£æ±ºã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `ResolveTenant` RPCãƒ¡ã‚½ãƒƒãƒ‰å®Ÿè£…
- TenantRepositoryã§DBã‹ã‚‰å–å¾—

**æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«**: `proto/api/v1/tenant.proto`ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

```protobuf
// æ³¨æ„: ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ã‚’æ¡ç”¨ã™ã‚‹å ´åˆã®ã¿å®Ÿè£…
// Tenantãƒ†ãƒ¼ãƒ–ãƒ«ã«subdomainãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™

message ResolveTenantRequest {
  string subdomain = 1;  // ä¾‹: "artist-a"
}

message ResolveTenantResponse {
  string firebase_tenant_id = 1;
  string tenant_name = 2;
}
```

**ä»£æ›¿æ¡ˆ**: ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ä»¥å¤–ã®æ–¹å¼ã‚’æ¡ç”¨ã™ã‚‹å ´åˆã€Firebase Tenant IDã‚’ç›´æ¥ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§è¨­å®šå¯èƒ½

```typescript
// ä¾‹: ãƒ“ãƒ«ãƒ‰æ™‚ã«Firebase Tenant IDã‚’åŸ‹ã‚è¾¼ã¿
const auth = getAuth();
auth.tenantId = import.meta.env.VITE_FIREBASE_TENANT_ID;
```

---

## Critical Filesï¼ˆé‡è¦ãªå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼‰

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

- âœï¸ **`packages/backend/prisma/schema.prisma`** - Tenantãƒ¢ãƒ‡ãƒ«è¿½åŠ ã€å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«tenant_idè¿½åŠ 
- ğŸ“ **`packages/backend/prisma/migrations/YYYYMMDDHHMMSS_add_tenant_table/migration.sql`** - Tenantãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–°è¦ç”Ÿæˆï¼‰
- ğŸ“ **`packages/backend/prisma/migrations/YYYYMMDDHHMMSS_add_tenant_id_to_all_tables/migration.sql`** - tenant_idè¿½åŠ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ–°è¦ç”Ÿæˆï¼‰

### Phase 2: Go Backend (rasen)

- âœï¸ **`packages/api/internal/adapter/gateway/rds/repository/store.go`** - `setTenantContext()`ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ã€`WithTx()`/`ReadOnly()`ä¿®æ­£ï¼ˆæœ€é‡è¦ï¼‰
- âœï¸ **`packages/api/internal/adapter/driver/middleware/firebase.go`** - Firebase Tenant IDæŠ½å‡ºã€contextã«è¨­å®š
- ğŸ†• **`packages/api/internal/adapter/driver/middleware/tenant.go`** - ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ï¼ˆJWT or X-Tenant-IDãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ï¼ˆæ–°è¦ä½œæˆï¼‰
- ğŸ†• **`packages/api/internal/adapter/driver/middleware/context.go`** - Context Keyå®šç¾©ï¼ˆæ–°è¦ä½œæˆï¼‰
- ğŸ†• **`packages/api/internal/domain/repository/store/tenant.go`** - TenantRepositoryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆæ–°è¦ä½œæˆï¼‰
- ğŸ†• **`packages/api/internal/adapter/gateway/rds/repository/tenant.go`** - TenantRepositoryå®Ÿè£…ï¼ˆæ–°è¦ä½œæˆï¼‰
- ğŸ†• **`packages/api/internal/db/queries/tenant.sql`** - ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºSQLï¼ˆæ–°è¦ä½œæˆï¼‰
- âœï¸ **`packages/api/internal/di/wire.go`** - TenantRepositoryè¿½åŠ 
- ğŸ“ **`packages/api/internal/db/rdb/*.go`** - sqlcè‡ªå‹•ç”Ÿæˆï¼ˆ`make gen`ã§æ›´æ–°ï¼‰
- ğŸ“ **`packages/api/internal/di/wire_gen.go`** - wireè‡ªå‹•ç”Ÿæˆï¼ˆ`make gen`ã§æ›´æ–°ï¼‰

### Phase 2: Node.js Backend (GraphQL)

- ğŸ†• **`packages/backend/src/utils/tenantPrisma.ts`** - Prisma Client Extensionã€SET LOCALå®Ÿè£…ï¼ˆæ–°è¦ä½œæˆï¼‰
- ğŸ†• **`packages/backend/src/infra/repository/tenantRepository.ts`** - TenantRepositoryå®Ÿè£…ï¼ˆæ–°è¦ä½œæˆï¼‰
- âœï¸ **`packages/backend/src/infra/repository/index.ts`** - TenantRepositoryè¿½åŠ 
- âœï¸ **`packages/backend/src/types/context.ts`** - ContextInjectå‹ã«tenantId, tenantClientè¿½åŠ 
- âœï¸ **`packages/backend/src/context.ts`** - Firebase Tenant IDæŠ½å‡ºã€ãƒ†ãƒŠãƒ³ãƒˆå¤‰æ›ã€tenantClientä½œæˆ

### Phase 3: RLSæœ‰åŠ¹åŒ–

- ğŸ“ **`packages/backend/prisma/migrations/YYYYMMDDHHMMSS_enable_rls_policies/migration.sql`** - RLSãƒãƒªã‚·ãƒ¼å®šç¾©ï¼ˆæ–°è¦ç”Ÿæˆï¼‰
- âœï¸ **`packages/api/internal/adapter/gateway/rds/repository/store.go`** - `setTenantContext()`ã®ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
- âœï¸ **`packages/backend/src/utils/tenantPrisma.ts`** - `SET LOCAL`ã®ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

- âœï¸ **`.github/workflows/deploy-backend-production.yaml`** - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤ï¼ˆ44-56è¡Œç›®ï¼‰

### Frontend & Tenantï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ« - æä¾›æ–¹é‡ç¢ºå®šå¾Œï¼‰

- ğŸ†• **`packages/web/app/utils/tenant.ts`** - ãƒ†ãƒŠãƒ³ãƒˆè­˜åˆ¥ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ–°è¦ä½œæˆã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ã®å ´åˆï¼‰
- âœï¸ **`packages/web/app/features/auth/Auth.tsx`** - Firebase Tenant IDè¨­å®š
- ğŸ†• **`packages/api/internal/adapter/driver/proto/tenant.go`** - ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæ–°è¦ä½œæˆã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ã®å ´åˆï¼‰
- ğŸ†• **`proto/api/v1/tenant.proto`** - ãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºAPIå®šç¾©ï¼ˆæ–°è¦ä½œæˆã€ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ã®å ´åˆï¼‰

**æ³¨æ„**: ãƒ†ãƒŠãƒ³ãƒˆæä¾›æ–¹é‡ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹/ãƒ“ãƒ«ãƒ‰æ™‚åŸ‹ã‚è¾¼ã¿ç­‰ï¼‰ãŒç¢ºå®šã—ã¦ã‹ã‚‰å®Ÿè£…ã—ã¦ãã ã•ã„ã€‚

**å‡¡ä¾‹**:

- ğŸ†• æ–°è¦ä½œæˆãƒ•ã‚¡ã‚¤ãƒ«
- âœï¸ æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ä¿®æ­£
- ğŸ“ è‡ªå‹•ç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ„ãƒ¼ãƒ«ã§æ›´æ–°ï¼‰

---

## Verificationï¼ˆæ¤œè¨¼æ–¹æ³•ï¼‰

### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ã®çµ±åˆãƒ†ã‚¹ãƒˆ

1. **ãƒ†ãƒŠãƒ³ãƒˆä½œæˆ**:

   ```sql
   INSERT INTO "tenant" (id, firebase_tenant_id, name, created_at, updated_at)
   VALUES
     ('tenant-a', 'firebase-tenant-a', 'Artist A', NOW(), NOW()),
     ('tenant-b', 'firebase-tenant-b', 'Artist B', NOW(), NOW());
   ```

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²**:
   - Firebase Tenant IDã‚’è¨­å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã‚’ç™»éŒ²ï¼ˆãƒ†ãƒŠãƒ³ãƒˆAï¼‰
   - Firebase Tenant IDã‚’è¨­å®šã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã‚’ç™»éŒ²ï¼ˆãƒ†ãƒŠãƒ³ãƒˆBï¼‰
   - æ³¨æ„: ãƒ†ãƒŠãƒ³ãƒˆæä¾›æ–¹æ³•ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹ç­‰ï¼‰ãŒç¢ºå®šã—ãŸã‚‰ã€ãã‚Œã«å¾“ã†

3. **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç¢ºèª**:
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã§ãƒ­ã‚°ã‚¤ãƒ³ â†’ ãƒ†ãƒŠãƒ³ãƒˆBã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ»ãƒ‘ãƒƒã‚¯ãŒè¦‹ãˆãªã„ã“ã¨ã‚’ç¢ºèª
   - æ±ºæ¸ˆå‡¦ç† â†’ payment_transactionã®tenant_idãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

4. **RLSå‹•ä½œç¢ºèª**:

   ```sql
   -- ãƒ†ãƒŠãƒ³ãƒˆAã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§ã‚¯ã‚¨ãƒªå®Ÿè¡Œ
   SET LOCAL app.current_tenant_id = 'tenant-a';
   SELECT * FROM "user"; -- ãƒ†ãƒŠãƒ³ãƒˆAã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º

   -- ãƒ†ãƒŠãƒ³ãƒˆBã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
   SET LOCAL app.current_tenant_id = 'tenant-b';
   SELECT * FROM "user"; -- ãƒ†ãƒŠãƒ³ãƒˆBã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿è¡¨ç¤º
   ```

5. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ**:
   - è² è·ãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ï¼ˆk6ãªã©ï¼‰ã§Phase 2ã¨Phase 3ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã‚’æ¯”è¼ƒ
   - ç›®æ¨™: 20%ä»¥å†…ã®åŠ£åŒ–

---

## ãƒªã‚¹ã‚¯è©•ä¾¡

### é«˜ãƒªã‚¹ã‚¯

1. **RLSæœ‰åŠ¹åŒ–æ™‚ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯** - ãƒãƒªã‚·ãƒ¼è¨­å®šãƒŸã‚¹ã§å…¨ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
   - è»½æ¸›ç­–: ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ååˆ†ãƒ†ã‚¹ãƒˆã€æœ¬ç•ªã¯ä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚é–“å¸¯

2. **SET LOCALã®å®Ÿè¡Œæ¼ã‚Œ** - ãƒ†ãƒŠãƒ³ãƒˆIDæœªè¨­å®šã§èª¤ã£ãŸãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
   - è»½æ¸›ç­–: å…¨ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ç‚¹ã§å¿…ãšå®Ÿè¡Œã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã§æ¤œè¨¼

### ä¸­ãƒªã‚¹ã‚¯

3. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å¤±æ•—** - Phase 1ã§ã®ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚¨ãƒ©ãƒ¼
   - è»½æ¸›ç­–: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ

4. **Firebase Tenantè¨­å®šã®è¤‡é›‘ã•** - ãƒ†ãƒŠãƒ³ãƒˆåˆ¥èªè¨¼ã®è¨­å®šãƒŸã‚¹
   - è»½æ¸›ç­–: è¨­å®šãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆä½œæˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

### ä½ãƒªã‚¹ã‚¯

5. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–** - SET LOCALã¨RLSã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
   - è»½æ¸›ç­–: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã§è² è·ãƒ†ã‚¹ãƒˆ

---

## å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ¦‚ç®—ï¼‰

| Phase                     | å·¥æ•°   | ä¸¦è¡Œå¯èƒ½ã‚¿ã‚¹ã‚¯                     |
| ------------------------- | ------ | ---------------------------------- |
| Phase 1: ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´     | 2æ—¥    | -                                  |
| Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£… | 5ã€œ7æ—¥ | ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³å®Ÿè£…ï¼ˆ3ã€œ4æ—¥ï¼‰ã¨ä¸¦è¡Œå¯ |
| Phase 3: RLSæœ‰åŠ¹åŒ–        | 3ã€œ4æ—¥ | -                                  |
| Phase 4: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚° | 3ã€œ4æ—¥ | -                                  |

**åˆè¨ˆ**: 13ã€œ17å–¶æ¥­æ—¥ï¼ˆç´„3ã€œ4é€±é–“ï¼‰

**ä¾å­˜é–¢ä¿‚**: Phase 1 â†’ Phase 2 â†’ Phase 3 â†’ Phase 4ï¼ˆé †æ¬¡å®Ÿè¡Œå¿…é ˆï¼‰

---

## æœªè§£æ±ºäº‹é …

1. **ç®¡ç†ãƒ„ãƒ¼ãƒ«ï¼ˆAdmin Packageï¼‰ã®ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ**
   - å…¨ãƒ†ãƒŠãƒ³ãƒˆã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
   - å¯¾å¿œç­–: ç®¡ç†è€…ç”¨DBãƒ¦ãƒ¼ã‚¶ãƒ¼ã§RLSãƒã‚¤ãƒ‘ã‚¹ã€ã¾ãŸã¯å‹•çš„ãªSET LOCALåˆ‡æ›¿

2. **æœ¬ç•ªç’°å¢ƒã§ã®ã‚¼ãƒ­ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ç§»è¡Œ**
   - Blue-Green Deploymentã¾ãŸã¯Canary Releaseã®æ¤œè¨

3. **Firebase Tenantä½œæˆã®è‡ªå‹•åŒ–**
   - æ–°ãƒ†ãƒŠãƒ³ãƒˆè¿½åŠ æ™‚ã®Firebase Tenantè‡ªå‹•ä½œæˆãƒ•ãƒ­ãƒ¼

---

## å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´

#### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

- [x] `packages/backend/prisma/schema.prisma`ã«Tenantãƒ¢ãƒ‡ãƒ«è¿½åŠ 
- [x] 19ãƒ†ãƒ¼ãƒ–ãƒ«ã«tenantIdãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
- [ ] `pnpm prisma migrate dev --create-only --name add_tenant_table`å®Ÿè¡Œ
- [ ] `pnpm prisma migrate dev --create-only --name add_tenant_id_to_all_tables`å®Ÿè¡Œ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ï¼ˆæ®µéšçš„ã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´ï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«DBã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ»å‹•ä½œç¢ºèª
- [ ] ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥

#### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ

- [ ] `.github/workflows/deploy-backend-production.yaml`ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ç¢ºèª
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèªï¼ˆtenant_idè¿½åŠ ã€æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å®Œäº†ï¼‰

#### æœ¬ç•ªç’°å¢ƒï¼ˆPhase 1å®Œäº†å¾Œï¼‰

- [ ] Cloud SQLãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèª
- [ ] `.github/workflows/deploy-backend-production.yaml`ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–æœ‰åŠ¹åŒ–
- [ ] ä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚é–“å¸¯ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª

---

### Phase 2: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…

#### Go Backend (rasen)

- [ ] `packages/api/internal/adapter/driver/middleware/context.go`ä½œæˆï¼ˆContext Keyå®šç¾©ï¼‰
- [ ] `packages/api/internal/adapter/driver/middleware/firebase.go`ä¿®æ­£ï¼ˆFirebase Tenant IDæŠ½å‡ºï¼‰
- [ ] `packages/api/internal/adapter/driver/middleware/tenant.go`ä½œæˆï¼ˆãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢: JWT or X-Tenant-IDãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰
- [ ] `packages/api/internal/domain/repository/store/tenant.go`ä½œæˆï¼ˆTenantRepositoryã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼‰
- [ ] `packages/api/internal/db/queries/tenant.sql`ä½œæˆï¼ˆSQLå®šç¾©ï¼‰
- [ ] `packages/api/internal/adapter/gateway/rds/repository/tenant.go`ä½œæˆï¼ˆTenantRepositoryå®Ÿè£…ï¼‰
- [ ] `packages/api/internal/adapter/gateway/rds/repository/store.go`ä¿®æ­£ï¼ˆ`setTenantContext()`è¿½åŠ ã€**ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆçŠ¶æ…‹**ï¼‰
- [ ] `packages/api/internal/di/wire.go`ä¿®æ­£ï¼ˆTenantRepositoryè¿½åŠ ï¼‰
- [ ] `cd packages/api && make gen`å®Ÿè¡Œï¼ˆsqlc, wireå†ç”Ÿæˆï¼‰
- [ ] `cd packages/api && make test`å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»å®Ÿè¡Œï¼‰
- [ ] ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥

#### Node.js Backend (GraphQL)

- [ ] `packages/backend/src/utils/tenantPrisma.ts`ä½œæˆï¼ˆPrisma Extensionã€**ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆçŠ¶æ…‹**ï¼‰
- [ ] `packages/backend/src/infra/repository/tenantRepository.ts`ä½œæˆï¼ˆTenantRepositoryå®Ÿè£…ï¼‰
- [ ] `packages/backend/src/infra/repository/index.ts`ä¿®æ­£ï¼ˆTenantRepositoryè¿½åŠ ï¼‰
- [ ] `packages/backend/src/types/context.ts`ä¿®æ­£ï¼ˆtenantId, tenantClientè¿½åŠ ï¼‰
- [ ] `packages/backend/src/context.ts`ä¿®æ­£ï¼ˆFirebase Tenant IDæŠ½å‡ºã€å¤‰æ›ï¼‰
- [ ] `cd packages/backend && pnpm prisma:generate`å®Ÿè¡Œ
- [ ] `cd packages/backend && pnpm test`å®Ÿè¡Œï¼ˆãƒ†ã‚¹ãƒˆè¿½åŠ ãƒ»å®Ÿè¡Œï¼‰
- [ ] ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥

#### ãƒ‡ãƒ—ãƒ­ã‚¤

- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆï¼ˆæ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªï¼‰
- [ ] GitHub Actions > deploy-rasen-production > Run workflow
- [ ] GitHub Actions > deploy-backend-production > Run workflow
- [ ] æœ¬ç•ªç’°å¢ƒã§æ—¢å­˜æ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª

---

### Phase 3: RLSæœ‰åŠ¹åŒ–

#### RLSãƒãƒªã‚·ãƒ¼å®šç¾©

- [ ] `cd packages/backend && pnpm prisma migrate dev --create-only --name enable_rls_policies`å®Ÿè¡Œ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç·¨é›†ï¼ˆ19ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSæœ‰åŠ¹åŒ– + ãƒãƒªã‚·ãƒ¼ä½œæˆï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«DBã§å‹•ä½œç¢ºèª

#### SET LOCALæœ‰åŠ¹åŒ–

- [ ] `packages/api/internal/adapter/gateway/rds/repository/store.go`ã®`setTenantContext()`ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
- [ ] `packages/backend/src/utils/tenantPrisma.ts`ã®`SET LOCAL`ã‚³ãƒ¡ãƒ³ãƒˆè§£é™¤
- [ ] `cd packages/api && make test`å®Ÿè¡Œ
- [ ] `cd packages/backend && pnpm test`å®Ÿè¡Œ
- [ ] ã‚³ãƒŸãƒƒãƒˆ & ãƒ—ãƒƒã‚·ãƒ¥

#### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒãƒ†ã‚¹ãƒˆ

- [ ] ãƒ†ãƒŠãƒ³ãƒˆA, Bã®ãƒ‡ãƒ¼ã‚¿ä½œæˆï¼ˆSQL INSERTï¼‰
- [ ] Firebase TenantA, Bä½œæˆ
- [ ] ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šï¼ˆDNSï¼‰
- [ ] ãƒ†ãƒŠãƒ³ãƒˆAã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
- [ ] ãƒ†ãƒŠãƒ³ãƒˆBã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³
- [ ] ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ç¢ºèªï¼ˆãƒ†ãƒŠãƒ³ãƒˆAã§ãƒ†ãƒŠãƒ³ãƒˆBã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ãˆãªã„ï¼‰
- [ ] ä¸»è¦ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œï¼ˆæ±ºæ¸ˆã€ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ã‚«ãƒ¼ãƒ‰ç²å¾—ï¼‰
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›´æ¥ç¢ºèªï¼ˆRLSå‹•ä½œç¢ºèªï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆï¼ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ¸¬å®šï¼‰

#### æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤

- [ ] Cloud SQLãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å–å¾—
- [ ] ä½ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯æ™‚é–“å¸¯ã‚’é¸å®š
- [ ] GitHub Actions > deploy-backend-production > Run workflowï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
- [ ] GitHub Actions > deploy-rasen-production > Run workflow
- [ ] æœ¬ç•ªç’°å¢ƒå‹•ä½œç¢ºèªï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ç›£è¦–ï¼ˆSentry, Cloud Loggingï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
- [ ] ï¼ˆç•°å¸¸æ™‚ï¼‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿæ–½

---

### Phase 4: ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

- [ ] RLSç¨¼åƒç¢ºèªï¼ˆ1é€±é–“ä»¥ä¸Šå®‰å®šç¨¼åƒï¼‰
- [ ] å†—é•·ãªWHEREå¥ã®ç‰¹å®š
- [ ] Go Backend: SQLã‚¯ã‚¨ãƒªã‹ã‚‰tenant_idãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰Šé™¤
- [ ] Node.js Backend: Repositoryã‹ã‚‰tenant_idãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‰Šé™¤
- [ ] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§å‹•ä½œç¢ºèª
- [ ] æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆè¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼‰

---

### ãƒ†ãƒŠãƒ³ãƒˆæä¾›æ–¹å¼ã®å®Ÿè£…ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ« - æä¾›æ–¹é‡ç¢ºå®šå¾Œï¼‰

**æ³¨æ„**: ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ãƒ†ãƒŠãƒ³ãƒˆæä¾›æ–¹é‡ï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³/ãƒ‘ã‚¹ãƒ™ãƒ¼ã‚¹/ãƒ“ãƒ«ãƒ‰æ™‚åŸ‹ã‚è¾¼ã¿ç­‰ï¼‰ãŒç¢ºå®šã—ã¦ã‹ã‚‰å®Ÿæ–½ã—ã¦ãã ã•ã„ã€‚

#### ãƒ‘ã‚¿ãƒ¼ãƒ³A: ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ–¹å¼ã®å ´åˆ

##### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰

- [ ] Tenantãƒ†ãƒ¼ãƒ–ãƒ«ã«`subdomain`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- [ ] `packages/web/app/utils/tenant.ts`ä½œæˆï¼ˆã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ¤œå‡ºï¼‰
- [ ] `packages/web/app/features/auth/Auth.tsx`ä¿®æ­£ï¼ˆFirebase Tenantè¨­å®šï¼‰
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ

##### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰

- [ ] `proto/api/v1/tenant.proto`ä½œæˆï¼ˆãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºAPIå®šç¾©ï¼‰
- [ ] `cd proto && make gen`å®Ÿè¡Œ
- [ ] `packages/api/internal/adapter/driver/proto/tenant.go`ä½œæˆï¼ˆãƒ†ãƒŠãƒ³ãƒˆè§£æ±ºã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
- [ ] `cd packages/api && make gen && make test`å®Ÿè¡Œ
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] å‹•ä½œç¢ºèª

#### ãƒ‘ã‚¿ãƒ¼ãƒ³B: ãƒ“ãƒ«ãƒ‰æ™‚åŸ‹ã‚è¾¼ã¿æ–¹å¼ã®å ´åˆ

- [ ] `packages/web/app/features/auth/Auth.tsx`ä¿®æ­£ï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰Firebase Tenant IDå–å¾—ï¼‰
- [ ] ãƒ“ãƒ«ãƒ‰è¨­å®šã§ãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹Firebase Tenant IDã‚’åŸ‹ã‚è¾¼ã¿
- [ ] ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šï¼ˆãƒ†ãƒŠãƒ³ãƒˆã”ã¨ã«åˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤ï¼‰
