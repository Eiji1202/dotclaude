"use server";

import { prisma } from "@/lib/prisma";
import type { z } from "zod";
import type { schema } from "./GenerateForm";
import { $Enums, type Prisma } from "@/prisma/generated";
import crypto from "node:crypto";

export async function getCheckinCodeList() {
  return prisma.checkinCode.findMany({
    include: { event: true, pack: true },
    orderBy: {
      createdAt: "desc",
    },
  });
}

export async function getEventList() {
  return prisma.event.findMany({
    select: {
      id: true,
      name: true,
    },
    orderBy: {
      createdAt: "desc",
    },
  });
}

export async function getCertificateList() {
  return prisma.certificate.findMany({
    select: {
      id: true,
    },
    orderBy: {
      createdAt: "desc",
    },
  });
}

export async function getPackList() {
  return prisma.pack.findMany({
    select: {
      id: true,
      name: true,
    },
    orderBy: {
      createdAt: "desc",
    },
  });
}

export async function generateCheckinCode(payload: z.infer<typeof schema>) {
  const data: Prisma.CheckinCodeCreateManyInput[] = [];

  for (let i = 0; i < Number.parseInt(payload.count); i++) {
    data.push({
      id: crypto.randomUUID().split("-").join(""),
      eventId: Number.parseInt(payload.eventId),
      certificateId: Number.parseInt(payload.certificateId),
      packId: payload.packId,
      type: payload.type || $Enums.CheckinCodeType.PER_EVENT,
      grantType: payload.grantType || $Enums.CheckinGrantType.CHECKIN_GRANT_ALL,
    });
  }

  return prisma.$transaction(async (tx) => {
    const result = await tx.checkinCode.createMany({
      data,
    });

    const checkinCodeList = await tx.checkinCode.findMany({
      select: { id: true },
      take: result.count,
      orderBy: {
        createdAt: "desc",
      },
    });

    return checkinCodeList.map((i) => i.id);
  });
}
