import { toJST } from "../src/utils/date";
import { PrismaClient } from "./generated";

const prisma = new PrismaClient();

async function seed() {
  // デフォルトテナント作成
  const tenant = await prisma.tenant.upsert({
    where: { id: 1 },
    update: {},
    create: {
      firebaseTenantId: "default",
      name: "Default Tenant",
    },
  });

  const user = await prisma.user.upsert({
    where: { id: "test" },
    update: {},
    create: {
      id: "test",
      name: "TEST USER",
      lineId: "test-line-id",
      email: "test@test.com",
      imageURL: "https://storage.googleapis.com/utage3/assets/default-icon.png",
      nickname: "testuser",
      tenantId: tenant.id,
    },
  });

  const event = await prisma.event.upsert({
    where: { id: 1 },
    update: {},
    create: {
      id: 1,
      name: '"369ノ3" 全国ツアー @OWL OSAKA 2025/06/08',
      startDate: toJST("2025-06-01T00:00:00Z").toDate(),
      headerImageURL: "https://storage.googleapis.com/utage3/events/34.png",
      tenantId: tenant.id,
    },
  });

  const setlist = await prisma.eventSetlist.upsert({
    where: { id: 1 },
    update: {},
    create: {
      id: 1,
      eventId: event.id,
      artistName: "OZworld",
      content: "セトリ",
      spotifyURL:
        "https://open.spotify.com/playlist/3yPaYLJAtNVVzrq9f4I9Ci?si=f735040785774e06",
      appleMusicURL:
        "https://music.apple.com/jp/playlist/2025-06-08-369%E3%83%8E3-%E5%85%A8%E5%9B%BD%E3%83%84%E3%82%A2%E3%83%BC-%E5%A4%A7%E9%98%AA-owl-osaka/pl.u-RRbVvlxIee0EjYz",
      publishedAt: toJST("2025-06-01T00:00:00Z").toDate(),
      notificationDuration: 60 * 60 * 1,
      tenantId: tenant.id,
    },
  });

  const pack1 = await prisma.pack.upsert({
    where: { id: "658dcfa6bc70422ea10cba530ddc71bc" },
    update: {
      id: "658dcfa6bc70422ea10cba530ddc71bc",
      name: "テストパック",
      imageURL:
        "https://storage.googleapis.com/utage3/packs/658dcfa6bc70422ea10cba530ddc71bc/image.jpeg",
      cutImageURL: "<TODO cutImageURL>",
      scrapImageURL: "<TODO scrapImageURL>",
      openingVideoType: "blue",
    },
    create: {
      id: "658dcfa6bc70422ea10cba530ddc71bc",
      name: "テストパック",
      imageURL:
        "https://storage.googleapis.com/utage3/packs/658dcfa6bc70422ea10cba530ddc71bc/image.jpeg",
      cutImageURL: "<TODO cutImageURL>",
      scrapImageURL: "<TODO scrapImageURL>",
      openingVideoType: "blue",
      tenantId: tenant.id,
    },
  });

  const noPricePack = await prisma.pack.upsert({
    where: { id: "120f8b2a75bb4549a3baeb8c91c47457" },
    update: {
      id: "120f8b2a75bb4549a3baeb8c91c47457",
      name: "いちゃりば vol.2 @MIDNIGHT EAST / 東間屋 2024/08/09 来場者限定パック",
      imageURL:
        "https://storage.googleapis.com/utage3/packs/120f8b2a75bb4549a3baeb8c91c47457/full.png",
      cutImageURL: "<TODO cutImageURL>",
      scrapImageURL: "<TODO scrapImageURL>",
      openingVideoType: "rainbow",
    },
    create: {
      id: "120f8b2a75bb4549a3baeb8c91c47457",
      name: "いちゃりば vol.2 @MIDNIGHT EAST / 東間屋 2024/08/09 来場者限定パック",
      imageURL:
        "https://storage.googleapis.com/utage3/packs/120f8b2a75bb4549a3baeb8c91c47457/full.png",
      cutImageURL: "<TODO cutImageURL>",
      scrapImageURL: "<TODO scrapImageURL>",
      openingVideoType: "rainbow",
      tenantId: tenant.id,
    },
  });

  const secretPack = await prisma.pack.upsert({
    where: { id: "secret-pack" },
    update: {
      id: "secret-pack",
      name: "秘密のパック",
      public: false,
      imageURL:
        "https://storage.googleapis.com/utage3/packs/120f8b2a75bb4549a3baeb8c91c47457/full.png",
      cutImageURL: "<TODO cutImageURL>",
      scrapImageURL: "<TODO scrapImageURL>",
    },
    create: {
      id: "secret-pack",
      name: "秘密のパック",
      public: false,
      imageURL:
        "https://storage.googleapis.com/utage3/packs/120f8b2a75bb4549a3baeb8c91c47457/full.png",
      cutImageURL: "<TODO cutImageURL>",
      scrapImageURL: "<TODO scrapImageURL>",
      tenantId: tenant.id,
    },
  });

  const existingPackPrice1 = await prisma.packPrice.findFirst({
    where: { packId: pack1.id, minQuantity: 1 },
  });
  const packPrice1 = existingPackPrice1
    ? await prisma.packPrice.update({
        where: { id: existingPackPrice1.id },
        data: { price: 480, maxQuantity: 9 },
      })
    : await prisma.packPrice.create({
        data: {
          packId: pack1.id,
          price: 480,
          minQuantity: 1,
          maxQuantity: 9,
          tenantId: tenant.id,
        },
      });

  const existingPackPrice2 = await prisma.packPrice.findFirst({
    where: { packId: pack1.id, minQuantity: 10 },
  });
  const packPrice2 = existingPackPrice2
    ? await prisma.packPrice.update({
        where: { id: existingPackPrice2.id },
        data: { price: 440 },
      })
    : await prisma.packPrice.create({
        data: {
          packId: pack1.id,
          price: 440,
          minQuantity: 10,
          tenantId: tenant.id,
        },
      });

  const existingSecretPackPrice = await prisma.packPrice.findFirst({
    where: { packId: secretPack.id, minQuantity: 10 },
  });
  const secretPackPrice = existingSecretPackPrice
    ? await prisma.packPrice.update({
        where: { id: existingSecretPackPrice.id },
        data: { price: 440 },
      })
    : await prisma.packPrice.create({
        data: {
          packId: secretPack.id,
          price: 440,
          minQuantity: 10,
          tenantId: tenant.id,
        },
      });

  const benefit1 = await prisma.tradingCardBenefit.upsert({
    where: { id: 1 },
    update: {},
    create: {
      id: 1,
      name: "OZworld自筆オリジナルイラスト色紙",
      imageURL: "",
      exchangeMethod: "こちらの画面を物販ブースでスタッフにお見せください",
      expirationDate: toJST("2024-06-15T23:59:59Z").toDate(),
      expirationDateForUser: "ライブ終了まで",
      tenantId: tenant.id,
    },
  });

  const benefit2 = await prisma.tradingCardBenefit.upsert({
    where: { id: 2 },
    update: {},
    create: {
      id: 2,
      name: "HABUSH（最大ショット3杯まで）",
      imageURL: "",
      exchangeMethod: "こちらの画面を物販ブースでスタッフにお見せください",
      expirationDate: toJST("2025-06-15T23:59:59Z").toDate(),
      expirationDateForUser: "ライブ終了まで",
      tenantId: tenant.id,
    },
  });

  const tradingCard1 = await prisma.tradingCard.upsert({
    where: { id: "db6e2f35c00a4140a272d998eefbe7e4" },
    update: {},
    create: {
      id: "db6e2f35c00a4140a272d998eefbe7e4",
      name: "[001/UR] OZworld",
      imageURL:
        "https://storage.googleapis.com/utage3/trading-cards/db6e2f35c00a4140a272d998eefbe7e4/default.png",
      backImageURL:
        "https://storage.googleapis.com/utage3/trading-cards/back.png",
      usedImageURL:
        "https://storage.googleapis.com/utage3/trading-cards/db6e2f35c00a4140a272d998eefbe7e4/used.png",
      benefitId: benefit1.id,
      tenantId: tenant.id,
    },
  });

  const tradingCard2 = await prisma.tradingCard.upsert({
    where: { id: "0427037bfa4e4b3d8b2c82aac0d062af" },
    update: {},
    create: {
      id: "0427037bfa4e4b3d8b2c82aac0d062af",
      name: "[002/SR] OZworld (Off-shot)",
      imageURL:
        "https://storage.googleapis.com/utage3/trading-cards/0427037bfa4e4b3d8b2c82aac0d062af/default.png",
      backImageURL:
        "https://storage.googleapis.com/utage3/trading-cards/back.png",
      tenantId: tenant.id,
    },
  });

  const tradingCard3 = await prisma.tradingCard.upsert({
    where: { id: "3ae18ade2ec44d7b8925f791a10abcda" },
    update: {},
    create: {
      id: "3ae18ade2ec44d7b8925f791a10abcda",
      name: "[003/UC] HABUSH",
      imageURL:
        "https://storage.googleapis.com/utage3/trading-cards/3ae18ade2ec44d7b8925f791a10abcda/default.png",
      backImageURL:
        "https://storage.googleapis.com/utage3/trading-cards/back.png",
      usedImageURL:
        "https://storage.googleapis.com/utage3/trading-cards/3ae18ade2ec44d7b8925f791a10abcda/used.png",
      benefitId: benefit2.id,
      tenantId: tenant.id,
    },
  });

  const packTradingCardRelation1 = await prisma.packTradingCardRelation.upsert({
    where: {
      packId_tradingCardId: {
        packId: pack1.id,
        tradingCardId: tradingCard1.id,
      },
    },
    update: {
      chance: 0.2,
      paidChance: 0.2,
      maxCount: 3,
    },
    create: {
      packId: pack1.id,
      tradingCardId: tradingCard1.id,
      chance: 0.2,
      paidChance: 0.2,
      maxCount: 3,
      tenantId: tenant.id,
    },
  });

  const packTradingCardRelation2 = await prisma.packTradingCardRelation.upsert({
    where: {
      packId_tradingCardId: {
        packId: pack1.id,
        tradingCardId: tradingCard2.id,
      },
    },
    update: {
      chance: 0.2,
      paidChance: 0.2,
    },
    create: {
      packId: pack1.id,
      tradingCardId: tradingCard2.id,
      chance: 0.2,
      paidChance: 0.2,
      tenantId: tenant.id,
    },
  });

  const packTradingCardRelation3 = await prisma.packTradingCardRelation.upsert({
    where: {
      packId_tradingCardId: {
        packId: pack1.id,
        tradingCardId: tradingCard3.id,
      },
    },
    update: {
      chance: 0.6,
      paidChance: 0.6,
      maxCount: 10,
    },
    create: {
      packId: pack1.id,
      tradingCardId: tradingCard3.id,
      chance: 0.6,
      paidChance: 0.6,
      maxCount: 10,
      tenantId: tenant.id,
    },
  });

  const certificate = await prisma.certificate.upsert({
    where: { id: 1 },
    update: {},
    create: {
      id: 1,
      imageURL: "https://storage.googleapis.com/utage3/certificates/1.png",
      tenantId: tenant.id,
    },
  });

  const checkinCode = await prisma.checkinCode.upsert({
    where: { id: "test-code" },
    update: {},
    create: {
      id: "test-code",
      eventId: event.id,
      certificateId: certificate.id,
      packId: pack1.id,
      tenantId: tenant.id,
    },
  });

  console.log("✅ Seeding completed!");

  return {
    user,
    event,
    setlist,
    pack1,
    noPricePack,
    secretPack,
    packPrice1,
    packPrice2,
    secretPackPrice,
    benefit1,
    benefit2,
    tradingCard1,
    tradingCard2,
    tradingCard3,
    packTradingCardRelation1,
    packTradingCardRelation2,
    packTradingCardRelation3,
    certificate,
    checkinCode,
  };
}

seed()
  .catch((error) => {
    console.error(error);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
