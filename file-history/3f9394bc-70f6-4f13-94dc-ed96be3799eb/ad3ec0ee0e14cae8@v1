import { GraphQLError } from "graphql/error";
import type { ContextInject } from "~/context";
import type { CheckinTransactionMapper } from "~/graphql/event/schema.mappers";
import type { BusinessCardCheckinInput } from "~/graphql/types.generated";
import { generateUserCertificateImage } from "~/logic/generateUserCertificateImage";
import { assertAuthenticated } from "~/utils/assertAuthenticated";
import { assertExists } from "~/utils/assetExists";
import { logger } from "~/utils/logger";

const MEMBER_CODE_TRADING_CARD_MAP = new Map<string, string>([
  // partners
  ["osamusuzuki", "90792a168f6d40f5a7cd9231bc0c71c7"],
  ["SKY-HI", "756d173a3e774e94a62c086e8708aa27"],
  ["yutori", "76fcd6ff95ea49aeaa6e2953317af091"],
  ["chori", "8c17097adeee4c38bcaba834aebf6840"],
  ["okuta", "ccf5460792e94e2c9a4f5e56eeed0f8f"],
  ["kinopi", "5a8d8ef6291549c2a9a3a1294a0faf85"],
  ["daisukeiwase", "0dd60af3512f432ba7820b8379b6d3d4"],
  ["kinopi", "5a8d8ef6291549c2a9a3a1294a0faf85"],
  ["satoshi", "7c48496fa65043ff9ccbf7dc57318013"],
  ["maesan", "eba5918f66a3400bbe24303034c383cf"],
  ["sean", "b7fcc71b53114dbab96c88f40b83cb9b"],
  // members
  ["tucky", "f0fde2fdc4a94136add96eb463085f5f"],
  ["monami", "7aaf6bf9df534457866bf98b9dbbe8f6"],
  ["ozworld", "bea5bc6ac00d479385d63b0c2abf77c9"],
  ["wataame", "c97d2685500943cead91226d9f8f309a"],
  ["jj", "522f28332bf94c5898a685c0b0640ef1"],
  ["goto", "ad8f83ff529540e095fa071d53c9e303"],
  ["kato", "3ee9edc82b1b4d1cac4ba37934fa2fce"],
  ["ryo", "be38406f8d604d969dee35e09fd5c917"],
  ["kodai", "6d8eb7a6fe7e4d7ca7e9ac86dc243dec"],
]);

export class BusinessCardDataSource {
  private context: ContextInject;

  public constructor(context: ContextInject) {
    this.context = context;
  }

  private assertCorrectCode(code: string) {
    const membersCode = [...MEMBER_CODE_TRADING_CARD_MAP.keys()];
    if (!membersCode.includes(code)) {
      throw new GraphQLError("Invalid code", {
        extensions: { code: "NOT_FOUND" },
      });
    }
  }

  // 指定されたコードでイベントにチェックインする。
  public async businessCardCheckin(
    input: BusinessCardCheckinInput,
  ): Promise<CheckinTransactionMapper> {
    const uid = assertAuthenticated(this.context.uid);
    const repo = this.context.repository.businessCard;
    const sideEffect = this.context.sideEffect;

    const user = await repo.findUniqueUser(uid);
    assertExists(user, "User");

    try {
      return await repo.withTransaction(async (tx) => {
        this.assertCorrectCode(input.code);

        const checkinCode = await repo.findUniqueCheckinCodeWithCertificate(
          "bussinesscard-checkin",
          { tx },
        );
        assertExists(checkinCode, "CheckinCode");

        const now = sideEffect.clock().toDate();

        const checkinTransaction = await repo.upsertCheckinTransaction(
          {
            checkinCodeId: checkinCode.id,
            eventId: checkinCode.eventId,
            uid,
            now,
          },
          { tx },
        );

        const certificate = await (async () => {
          // すでにユーザーの証明書が存在すればそれを返す
          const userCertificate = await repo.findFirstUserCertificate(
            checkinTransaction.id,
            { tx },
          );
          if (userCertificate != null) return userCertificate;

          const imageURL = await (async () => {
            try {
              return await generateUserCertificateImage({
                context: this.context,
                eventId: checkinCode.eventId,
                imageURL: checkinCode.certificate.imageURL,
                uid,
                name: user.name ?? "",
                icon: user.imageURL,
              });
            } catch (error) {
              logger.error("failed to generate user certificate image", error, {
                uid,
                input,
              });

              // ユーザーの来場パス画像の生成に失敗した場合、元の来場パスの画像を設定して checkin できるようにする
              return checkinCode.certificate.imageURL;
            }
          })();

          return await repo.createUserCertificate(
            {
              checkinTransactionId: checkinTransaction.id,
              uid,
              imageURL,
            },
            { tx },
          );
        })();

        const userTradingCards = await (async () => {
          const targetTradingCardId = MEMBER_CODE_TRADING_CARD_MAP.get(
            input.code,
          );
          assertExists(targetTradingCardId, "TradingCard");

          const tradingCard = await repo.findFirstTradingCard(
            targetTradingCardId,
            { tx },
          );
          assertExists(tradingCard, "TradingCard");

          // target のトレカを持っている数を確認（0 or 1）
          const targetTradingCardCount = await repo.countUserTradingCard(
            {
              uid,
              tradingCardId: targetTradingCardId,
            },
            { tx },
          );

          // 0 の場合は新しくトレカを作成
          if (targetTradingCardCount === 0) {
            await repo.createUserTradingCard(
              {
                uid,
                tradingCardId: targetTradingCardId,
                checkinTransactionId: checkinTransaction.id,
              },
              { tx },
            );
          }

          // checkinTransaction に紐づいた全てのビジネスカードを取得
          return await repo.findManyUserTradingCardWithTradingCard(
            {
              checkinTransactionId: checkinTransaction.id,
              tradingCardId: targetTradingCardId,
            },
            { tx },
          );
        })();

        return {
          ...checkinTransaction,
          certificate,
          tradingCards: userTradingCards.map((card) => {
            return {
              ...card,
              name: card.tradingCard.name,
              imageURL: card.tradingCard.imageURL,
              backImageURL: card.tradingCard.backImageURL,
              usedImageURL: card.tradingCard.usedImageURL,
            };
          }),
        } satisfies CheckinTransactionMapper;
      });
    } catch (error) {
      logger.error("failed to checkin", error, { uid, input });

      if (error instanceof GraphQLError) {
        throw error;
      }

      throw new GraphQLError("Failed to checkin", {
        extensions: { code: "INTERNAL_SERVER_ERROR" },
      });
    }
  }
}
