"use server";

import type { createEventSchema } from "@/app/event/schema";
import { jst } from "@/lib/date";
import { convertImageUrl } from "@/lib/image";
import { logger } from "@/lib/logger";
import { prisma } from "@/lib/prisma";
import type { z } from "zod";

export async function getEventList() {
  return prisma.event.findMany({ orderBy: { id: "desc" } });
}

export async function upsertEvent(data: z.infer<typeof createEventSchema>) {
  logger.info("upsertEvent", { data });

  const id = Number(data.id);

  const startDate = jst(data.startDate).toDate();
  const headerImageURL = convertImageUrl(data.headerImageURL || "");

  await prisma.event.upsert({
    where: { id },
    update: {
      id,
      name: data.name,
      startDate,
      headerImageURL,
      updatedAt: new Date(),
    },
    create: {
      id,
      name: data.name,
      startDate,
      headerImageURL,
      tenantId: "default-tenant",
    },
  });
}
