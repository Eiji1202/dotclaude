name: DB Migration

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
      cloud_sql_instance:
        type: string
        required: true
      workload_identity_provider:
        type: string
        required: true
      service_account:
        type: string
        required: true
    secrets:
      DATABASE_URL:
        required: true
      SLACK_NOTIFICATION_WEBHOOK_URL:
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment }}-db-migration
  cancel-in-progress: true

env:
  TZ: Asia/Tokyo
  NODE_VERSION: 22.14.0
  PNPM_VERSION: 10.7.1

defaults:
  run:
    working-directory: ./packages/backend

jobs:
  migrate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Node.js setup
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm setup
        uses: pnpm/action-setup@v4
        with:
          version: ${{env.PNPM_VERSION}}
          run_install: |
            - args: [--frozen-lockfile]

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2.1.2
        id: auth
        with:
          token_format: access_token
          workload_identity_provider: ${{ inputs.workload_identity_provider }}
          service_account: ${{ inputs.service_account }}

      - name: Start Cloud SQL Proxy
        shell: bash
        run: |
          wget https://dl.google.com/cloudsql/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy
          chmod +x cloud_sql_proxy

          ./cloud_sql_proxy --version

          mkdir /tmp/cloudsql
          ./cloud_sql_proxy -dir=/tmp/cloudsql -instances=${{inputs.cloud_sql_instance}} &

      - name: DB Migration
        shell: bash
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: DATABASE_URL=${DATABASE_URL/\/cloudsql/\/tmp\/cloudsql} pnpm prisma:migrate:deploy

      - name: Slack Notification(Success)
        uses: ./.github/actions/slack-notification
        if: success()
        with:
          webhook_url: ${{ secrets.SLACK_NOTIFICATION_WEBHOOK_URL }}
          title: "[DB Migration] ${{ inputs.environment }}"
          message: "DB Migration to ${{ inputs.environment }} completed successfully!"

      - name: Slack Notification(Failure)
        uses: ./.github/actions/slack-notification
        if: failure()
        with:
          webhook_url: ${{ secrets.SLACK_NOTIFICATION_WEBHOOK_URL }}
          title: "[DB Migration] ${{ inputs.environment }}"
          message: "DB Migration to ${{ inputs.environment }} failed!"
