-- ========================================
-- Step 1: Tenantテーブル作成
-- ========================================
CREATE TABLE "tenant" (
    "id" TEXT NOT NULL,
    "firebase_tenant_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "tenant_pkey" PRIMARY KEY ("id")
);

CREATE UNIQUE INDEX "tenant_firebase_tenant_id_key" ON "tenant"("firebase_tenant_id");

-- ========================================
-- Step 2: 19テーブルにtenant_idをNULL許容で追加
-- ========================================
ALTER TABLE "certificate" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "checkin_code" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "checkin_transaction" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "event" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "event_setlist" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "pack" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "pack_price" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "pack_trading_card_relation" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "pairing" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "payment_method" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "payment_transaction" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "physical_pack" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "quiz_survey" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "trading_card" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "trading_card_benefit" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "trading_card_benefit_exchange_transaction" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "user" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "user_certificate" ADD COLUMN "tenant_id" TEXT;
ALTER TABLE "user_trading_card" ADD COLUMN "tenant_id" TEXT;

-- ========================================
-- Step 3: デフォルトテナント作成 & 既存データのバックフィル
-- ========================================
INSERT INTO "tenant" (id, firebase_tenant_id, name, created_at, updated_at)
VALUES ('default-tenant', 'default-firebase-tenant', 'Default Tenant', NOW(), NOW())
ON CONFLICT (id) DO NOTHING;

UPDATE "certificate" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "checkin_code" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "checkin_transaction" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "event" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "event_setlist" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "pack" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "pack_price" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "pack_trading_card_relation" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "pairing" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "payment_method" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "payment_transaction" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "physical_pack" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "quiz_survey" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "trading_card" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "trading_card_benefit" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "trading_card_benefit_exchange_transaction" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "user" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "user_certificate" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;
UPDATE "user_trading_card" SET tenant_id = 'default-tenant' WHERE tenant_id IS NULL;

-- ========================================
-- Step 4: NOT NULL制約追加
-- ========================================
ALTER TABLE "certificate" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "checkin_code" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "checkin_transaction" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "event" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "event_setlist" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "pack" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "pack_price" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "pack_trading_card_relation" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "pairing" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "payment_method" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "payment_transaction" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "physical_pack" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "quiz_survey" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "trading_card" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "trading_card_benefit" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "trading_card_benefit_exchange_transaction" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "user" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "user_certificate" ALTER COLUMN "tenant_id" SET NOT NULL;
ALTER TABLE "user_trading_card" ALTER COLUMN "tenant_id" SET NOT NULL;

-- ========================================
-- Step 5: 外部キー制約追加
-- ========================================
ALTER TABLE "certificate" ADD CONSTRAINT "certificate_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "checkin_code" ADD CONSTRAINT "checkin_code_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "checkin_transaction" ADD CONSTRAINT "checkin_transaction_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "event" ADD CONSTRAINT "event_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "event_setlist" ADD CONSTRAINT "event_setlist_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "pack" ADD CONSTRAINT "pack_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "pack_price" ADD CONSTRAINT "pack_price_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "pack_trading_card_relation" ADD CONSTRAINT "pack_trading_card_relation_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "pairing" ADD CONSTRAINT "pairing_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "payment_method" ADD CONSTRAINT "payment_method_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "payment_transaction" ADD CONSTRAINT "payment_transaction_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "physical_pack" ADD CONSTRAINT "physical_pack_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "quiz_survey" ADD CONSTRAINT "quiz_survey_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "trading_card" ADD CONSTRAINT "trading_card_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "trading_card_benefit" ADD CONSTRAINT "trading_card_benefit_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "trading_card_benefit_exchange_transaction" ADD CONSTRAINT "trading_card_benefit_exchange_transaction_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "user" ADD CONSTRAINT "user_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "user_certificate" ADD CONSTRAINT "user_certificate_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;
ALTER TABLE "user_trading_card" ADD CONSTRAINT "user_trading_card_tenant_id_fkey" FOREIGN KEY ("tenant_id") REFERENCES "tenant"("id") ON DELETE RESTRICT ON UPDATE CASCADE;

-- ========================================
-- Step 6: パフォーマンス用インデックス作成
-- ========================================
CREATE INDEX "certificate_tenant_id_idx" ON "certificate"("tenant_id");
CREATE INDEX "checkin_code_tenant_id_idx" ON "checkin_code"("tenant_id");
CREATE INDEX "checkin_transaction_tenant_id_idx" ON "checkin_transaction"("tenant_id");
CREATE INDEX "event_tenant_id_idx" ON "event"("tenant_id");
CREATE INDEX "event_setlist_tenant_id_idx" ON "event_setlist"("tenant_id");
CREATE INDEX "pack_tenant_id_idx" ON "pack"("tenant_id");
CREATE INDEX "pack_price_tenant_id_idx" ON "pack_price"("tenant_id");
CREATE INDEX "pack_trading_card_relation_tenant_id_idx" ON "pack_trading_card_relation"("tenant_id");
CREATE INDEX "pairing_tenant_id_idx" ON "pairing"("tenant_id");
CREATE INDEX "payment_method_tenant_id_idx" ON "payment_method"("tenant_id");
CREATE INDEX "payment_transaction_tenant_id_idx" ON "payment_transaction"("tenant_id");
CREATE INDEX "physical_pack_tenant_id_idx" ON "physical_pack"("tenant_id");
CREATE INDEX "quiz_survey_tenant_id_idx" ON "quiz_survey"("tenant_id");
CREATE INDEX "trading_card_tenant_id_idx" ON "trading_card"("tenant_id");
CREATE INDEX "trading_card_benefit_tenant_id_idx" ON "trading_card_benefit"("tenant_id");
CREATE INDEX "trading_card_benefit_exchange_transaction_tenant_id_idx" ON "trading_card_benefit_exchange_transaction"("tenant_id");
CREATE INDEX "user_tenant_id_idx" ON "user"("tenant_id");
CREATE INDEX "user_certificate_tenant_id_idx" ON "user_certificate"("tenant_id");
CREATE INDEX "user_trading_card_tenant_id_idx" ON "user_trading_card"("tenant_id");
