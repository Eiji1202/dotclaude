import type { PaymentStatus, Prisma } from "@/prisma/generated";
import { prisma } from "~/utils/prisma";
import { defaultOption, type Option } from "./utils";

export class PaymentRepository {
  public async withTransaction<T>(
    fn: (tx: Prisma.TransactionClient) => Promise<T>,
  ) {
    return prisma.$transaction(fn);
  }

  public async findManyPaymentTransactionsByUserIdWithPaymentMethod(
    userId: string,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.paymentTransaction.findMany({
      where: { userId },
      include: { paymentMethod: true },
      orderBy: { createdAt: "desc" },
    });
  }

  public async findFirstPaymentTransactionByUserIdAndOrderIdWithPaymentMethod(
    userId: string,
    orderId: string,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.paymentTransaction.findFirst({
      where: { userId, orderId },
      include: { paymentMethod: true },
    });
  }

  public async findFirstPaymentTransactionByIdAndUserIdWithPack(
    id: number,
    userId: string,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.paymentTransaction.findFirst({
      where: { id, userId },
      include: { pack: true },
    });
  }

  public async findManyUserTradingCardsByPaymentTransactionIdAndUserIdWithTradingCard(
    paymentTransactionId: number,
    userId: string,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.userTradingCard.findMany({
      where: { paymentTransactionId, userId },
      include: { tradingCard: true },
    });
  }

  public async findUniqueUserById(
    id: string,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.user.findUnique({ where: { id } });
  }

  public async createPaymentMethod(
    args: {
      userId: string;
      type: "CARD" | "PAYPAY";
      cardId?: string;
      cardNo?: string;
      cardBrand?: string;
      tenantId: string;
    },
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };
    const { userId, type, cardId, cardNo, cardBrand, tenantId } = args;

    return tx.paymentMethod.create({
      data: { userId, type, cardId, cardNo, cardBrand, tenantId },
    });
  }

  public async createPaymentTransaction(
    args: {
      totalPrice: number;
      quantity: number;
      orderId: string;
      accessId: string;
      status: PaymentStatus;
      paymentMethodId: number;
      packId: string;
      userId: string;
      tenantId: string;
    },
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };
    const {
      totalPrice,
      quantity,
      orderId,
      accessId,
      status,
      paymentMethodId,
      packId,
      userId,
      tenantId,
    } = args;

    return tx.paymentTransaction.create({
      data: {
        userId,
        orderId,
        accessId,
        status,
        totalPrice,
        quantity,
        paymentMethodId,
        packId,
        tenantId,
      },
    });
  }

  public async updatePaymentTransactionStatus(
    id: number,
    status: PaymentStatus,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.paymentTransaction.update({
      where: { id },
      data: { status },
    });
  }

  public async findManyPackPricesByPackId(
    packId: string,
    option: Partial<Option> = defaultOption,
  ) {
    const { tx } = { ...defaultOption, ...option };

    return tx.packPrice.findMany({ where: { packId } });
  }
}
